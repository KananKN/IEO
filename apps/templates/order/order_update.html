{% extends "layouts/base.html" %}

{% block title %} ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ Order {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

<link href="{{ config.ASSETS_ROOT }}/plugins/datatables.net-bs5/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/select2/dist/css/select2.min.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/tag-it/css/jquery.tagit.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/select-picker/dist/picker.min.css" rel="stylesheet" />
 
 
<style>
    .input-group .form-control,
    .input-group .input-group-text,
    input[type="file"] {
        height: 35px; /* ‡∏´‡∏£‡∏∑‡∏≠ 100% ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô flex */
        line-height: 1.5;
}
.amount-error {
    font-size: 0.85rem;
    margin-top: 4px;
    display: block;
}
</style>
{% endblock stylesheets %}

{% block content %}

<form  id="myForm" data-parsley-validate="true" enctype="multipart/form-data"> 

    <div id="content" class="app-content">
            
        <div class="row">
            <div class="col-xl-12">
                <div class="panel panel-inverse">
                    <div class="panel-heading">
                        <h4 class="panel-title">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ Order </h4>
                        <div class="panel-heading-btn">
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload"><i class="fa fa-redo"></i></a>
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse"><i class="fa fa-minus"></i></a>
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-danger" data-toggle="panel-remove"><i class="fa fa-times"></i></a>
                        </div>
                    </div>
                    <div class="panel-body">
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for categorie, message in messages %}
                                    <div class="alert alert-{{categorie}} alert-dismissible fade show mb-2 mt-1">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endfor %}                    
                            {% endif %}
                        {% endwith %}

                    <div class="row">

                        <div class="card">
                            <div class="card-header bg-white">
                                <div class="d-flex justify-content-between">
                                    <h4 class="card-title my-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ Order</h4>  
                                    <div class="panel-heading-btn">
                                        <div class="d-flex align-items-center">

                                            <h4 class="mt-2">‡∏£‡∏´‡∏±‡∏™ Order {{ datas.order_number }}</h4>
                                            <button type="button"  class="btn btn-blue ms-3"  onclick="validateForm()">Save</button>
                                        </div>
                                    </div>
                                </div>
                            </div>   
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <h4 class="card-title mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤  </h4>  
                                        <div class="row mb-3" hidden >
                                            <label class="form-label col-form-label col-md-4">id</label>
                                            <div class="col-md-8">
                                                <input type="hidden"  class="form-control" name="id" id="id_order" value="{{datas.id}}" data-parsley-required="true"/>
                                                <input type="hidden"  class="form-control" name="id_member" id="id_member" value="{{members.member_code}}" data-parsley-required="true"/>
                                                <input type="hidden"  class="form-control" name="order_code" id="order_code" value="{{datas.order_number}}" data-parsley-required="true"/>
                                            </div>
                                        </div>    

                                        <div class="row">
                                            <label class="form-label col-form-label col-md-4">‡∏£‡∏´‡∏±‡∏™ Member:</label>
                                            <div class="col-lg-8">
                                                <input name="member_code" required class="form-control-plaintext   mx-2" value="{{members.member_code}}" readonly placeholder="‡∏ä‡∏∑‡πà‡∏≠">
                                            </div>
                                        </div>                        
                                        <div class="row mb-2">
                                            <label class="form-label col-form-label col-md-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                            <div class="col-lg-4">
                                                <input name="first_name" required class="form-control  me-2" value="{{members.first_name}} "  placeholder="‡∏ä‡∏∑‡πà‡∏≠">
                                                
                                            </div>
                                            <div class="col-lg-4">
                                                <input name="last_name" required class="form-control  me-2" value="{{members.last_name}}"  placeholder="‡∏ä‡∏∑‡πà‡∏≠">

                                            </div>
                                        </div>                        
                                        <div class="row mb-2">
                                            <label class="form-label col-form-label col-md-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</label>
                                            <div class="col-lg-4">
                                                <input name="first_nameEN" required class="form-control  me-2" value="{{members.first_nameEN}} "  placeholder="‡∏ä‡∏∑‡πà‡∏≠">
                                                
                                            </div>
                                            <div class="col-lg-4">
                                                <input name="last_nameEN" required class="form-control  me-2" value="{{members.last_nameEN}}"  placeholder="‡∏ä‡∏∑‡πà‡∏≠">

                                            </div>
                                        </div>                        
                                        <div class="form-group row mb-2" >
                                            <label class="form-label col-form-label col-lg-4">E-mail</label>

                                            <div class="col-lg-8">
                                                <input type="email" class="form-control" name="email" value="{{members.email}}" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">

                                            </div>
                
                                        </div>
                                        <div class="row ">
                                            <label class="form-label col-form-label col-md-4">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                                            <div class="col-lg-8 mb-2">
                                                <input name="nickname"  class="form-control me-2" value="{{members.nick_name}}"  placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô">
                                            </div>
                                        </div>

                                        <div class="row " hidden>
                                            <label class="form-label col-form-label col-md-4">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
                                            <div class="col-lg-8">
                                                <input type="text" class="form-control" id="masked-input-date" name="birth_date" value="{{ members.birth_date.strftime('%d/%m/%Y') if members.birth_date else '' }}" placeholder="dd/mm/yyyy">
                                            </div>
                                        </div>
                                    
                                        <div class="row mb-2">
                                            <label class="form-label col-form-label col-md-4">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                                            <div class="col-md-8">
                                                <input name="phone" required value="{{members.phone}}" class="form-control " placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå*">
                                            </div>
                                        </div>
                                        <div class="row mb-15px">
                                            <label class="form-label col-form-label col-md-4">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                                            <div class="col-md-8">
                                                <textarea class="form-control" id="address" rows="4" cols="50"  name="address" placeholder="" >{{members.address or '' }}</textarea>
                                            </div>
                                        </div>

                                        
                                        

                                    
                                    </div>
                                    <div class="col-sm-6 border-right pe-0">
                                        <div class="row mb-15px mt-4">
                                            <label class="form-label col-form-label col-md-4">Agency</label>
                                            <div class="col-md-8">
                                                <input name="agency" required value="{{datas.agency.first_name}} {{datas.agency.last_name}}" class="form-control-plaintext " placeholder="">
                                            </div>
                                        </div>
                                        

    
                                    </div>
                                </div>   
                                <hr>
                                <div class="row">
                                    <h4>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h4>
                                    <div class="col-md-5">
                                        <div class="row mt-3"  >
                                            <label class="form-label col-form-label col-md-3">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                                            <div class="col-md-8">
                                                <input type="text" class="form-control-plaintext" name="name_project" value="{{orderItem.product.name}}" placeholder="">
                                            </div>
                                        </div> 
                                        <div class="row"  >
                                            <label class="form-label col-form-label col-md-3">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏µ</label>
                                            <div class="col-md-8">
                                                <input type="text" class="form-control-plaintext" name="year" value="{{datas.year}}" placeholder="">
                                            </div>
                                        </div> 
                                        <div class="row"  >
                                            <label class="form-label col-form-label col-md-3">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                                            <div class="col-md-8">
                                                <input type="text" class="form-control-plaintext" name="period" value="{{datas.product.period.name}}" placeholder="">
                                            </div>
                                        </div> 
                                        <div class="row "  >
                                            <label class="form-label col-form-label col-md-3">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                                            <div class="col-md-8">
                                                <input type="text" class="form-control-plaintext" name="price" value="{{ datas.price | comma }}" placeholder="" onchange="formatInputNumberWithCommas(this)" >                                                
                                            </div>
                                        </div> 

                                        <div class="row " hidden >
                                            <label class="form-label col-form-label col-md-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î</label>
                                            <div class="col-md-8">
                                                <input type="text" class="form-control-plaintext" name="termOFpayment" value="{{ orderTerms|length }}" placeholder="" onchange="formatInputNumberWithCommas(this)" >                                                
                                            </div>
                                        </div> 
                                        
                                        

                                    </div>
                                    <div class="col-md-7">
                                        <div class="row mt-4"  >
                                            <div class="col-md-8">
                                                <p>{{ datas.product.detail or '' }}</p>
                                            </div>
                                        </div> 
                                    </div>
                                </div>
                                {% set show_index = 0 %}
{% for term in orderTerms %}
    {% if (term.outstanding_amount | float) > 0 and show_index == 0 %}
        {% set show_index = loop.index %}
    {% endif %}
{% endfor %}
                                  


                                <div class="row mt-3 g-3">
                                    <div class="col-xl-12">
                                        {% for term in orderTerms %}

                                        
                                        <!-- BEGIN #accordion -->
                                        <div class="accordion" id="accordion-{{ loop.index }}">
                                            <div class="accordion-item border-0" data-outstanding="{{ term.outstanding_amount or 0 }}">
                                                <div class="accordion-header" id="heading-{{ loop.index }}">
                                                    <button class="accordion-button text-drak px-3 py-10px pointer-cursor" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}" aria-expanded="{{ 'true' if loop.first else 'false' }}"
                                                    aria-controls="collapse-{{ loop.index }}">
                                                        <div class="d-flex w-100 align-items-center" style="flex-wrap: nowrap;" >
                                                            <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏ß‡∏î -->
                                                            <div class="left-section pe-2" style="width: 50%;" >
                                                                <div class="d-flex flex-row align-items-center gap-2 ">
                                                                    <label class="col-form-label fw-bold">{{ term.term_detail }}</label>
                                                                </div>
                                                            </div>
                                                            <div class="right-section ps-2" style="width: 50%;" >
                                                                <div class="d-flex flex-row align-items-center gap-2">
                                                                    <div class="mx-1 mt-1">
                                                                        <input type="hidden" name="term_id" value="{{ term.id }}">
                                                                        <input type="text" class="form-control text-end " name="installments" data-term-id="{{ term.id }}" value="{{ '{:,.2f}'.format(term.amount)}}" readonly placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
                                                                    </div>
                                                    
                                                                    <div class="mx-1 ms-2">
                                                                        <input type="text" class="form-control text-end price-input" name="discount"data-term-id="{{ term.id }}" 
                                                                            oninput="formatInputNumberWithCommasDiscount(this);check_discounts(this)" onfocus="clearZeroWhenTyping(this)"
                                                                            value="{{ '{:,.2f}'.format(term.discount)}}" placeholder="‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î">
                                                                    </div>
                                                    
                                                                    <div class="mx-1">
                                                                        <input type="text" class="form-control text-end price-input" name="count" data-term-id="{{ term.id }}"
                                                                            value="{{ '{:,.2f}'.format(term.net_price)}}" oninput="formatInputNumberWithCommas(this)" readonly placeholder="‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤">
                                                                    </div>
                                                                    <div class="mx-1">
                                                                        <label class="col-form-label fw-bold w-50px">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</label>
                                
                                                                    </div>
                                                                    <div class="mx-1">
                                                                        <input type="text" class="form-control text-end price-input" name="outstanding_amount" data-term-id="{{ term.id }}"
                                                                            value="{{ '{:,.2f}'.format(term.outstanding_amount or 0)}}" oninput="formatInputNumberWithCommas(this)" readonly placeholder="‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞">
                                                                    </div>
                                
                                                                </div>
                                                            </div>
                                                    
                                                            
                                                        </div>
                                                        
                                                    </button>
                                                </div>
                                            
                                                <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse {% if loop.index == show_index and show_index != 0 %} show {% endif %}" 
                                                aria-labelledby="heading-{{ loop.index }}" 
                                                data-bs-parent="#accordion-{{ loop.index }} ">
                                                    <div class="accordion-body text-drak bg-white ">
                                                        
                                                            <div class="row " id="term-form-{{ term.id }}"> 
                                                                <div class="col-md-6 h-100 d-flex align-items-center justify-content-center flex-column gap-2 ">
                                                                    <div class="d-flex flex-row align-items-center w-100 ">
                                                                        <label class="col-md-3 col-form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</label>
                                                                        

                                                                        <input type="hidden" name="term_ids" value="{{ term.id }}">
                                                                        
                                                                
                                                                        <div class="d-flex align-items-center  flex-grow-1  ">
                                                                            <div class="input-group date flex-grow-1 me-2" id="datepicker-disabled-past{{ term.id }}" data-date-format="dd-mm-yyyy" style="height: 35px; max-width: 230px;" >
                                                                                <input type="text" class="form-control  datetimepicker ps-2" placeholder="Select Date"
                                                                                    id="kt_datepicker_{{ term.id }}" name="payment_dates" autocomplete="off"
                                                                                    value="" />
                                                                                <span class="input-group-text input-group-addon">
                                                                                    <i class="fa fa-calendar"></i>
                                                                                </span>
                                                                            </div>
                                                                            


                                                                            <div class="mx-1 w-100px ms-2">
                                                                                <input type="text" class="form-control text-end price-input" name="amount" data-term-id="{{ term.id }}"
                                                                                    value="0" oninput="formatInputNumberWithCommas(this); check_price(this)"  placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
                                                                            </div>
                                                                            
                                                                            <input hidden name="check_count" value="{{ '{:,.2f}'.format(term.outstanding_amount or 0) }}">
                                                                            <input  name="total_pay" hidden data-term-id="{{ term.id }}" value="0">
                                                                        </div>
                                                                
                                                                    </div>
                                                                    
                                                                    <div class="d-flex flex-row  flex-grow-1 w-100 ">
                                                                        <label class="col-md-3 col-form-label"></label>
                                    
                                                                        <input class="form-control formFileInput me-2" type="file" id="file-{{ term.id }}" name="formFile_payment" 
                                                                            accept=".pdf, .jpg, .jpeg, .png" onchange="validateFile(this)"
                                                                            style="height: 35px; max-width: 230px;" />
                                                                            
                                                                        <div class="mx-1 w-100px ps-1">
                                                                            <a href="javascript:;" class="btn btn-primary w-100px" onclick="saveSingleTerm({{ term.id }},this)">Save</a>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    <!-- <a href="#" class="pt-2 ps-2" onclick="sweetAlerPrintfile({{term.id}},{{datas.id}})" hidden>
                                                                        <i class="material-icons">print</i>
                                                                    </a> -->
                                                                </div>
                                                                
                                                                <div class="col-md-6 d-flex align-items-center justify-content-center flex-column gap-2 ps-0">
                                                                    

                                                                    {% set payment_file_list = term_payment_files_map.get(term.id, []) %}
                                                                    {% if payment_file_list %}
                                                                        {% for pf in payment_file_list %}
                                                                            <div class="d-flex w-100" id="existing_files_{{ pf.file.id }} ps-0">
                                                                                <div class="attached-file w-425px" data-file-id="{{ pf.file.id }}">
                                                                                    <a href="{{ url_for('order_blueprint.downloadPayment', filename=pf.file.filename) }}"
                                                                                    style="text-decoration: none; color: black;">
                                                                                        <i class="fas fa-lg fa-fw ms-5px fa-file"></i>
                                                                                        <span class="fs-6">{{ pf.file.filename }}</span>
                                                                                    </a>
                                                                                    <a href="#" onclick="sweetAlertDelfile({{ pf.file.id }}, {{ datas.id }})">
                                                                                        <i class="fas fa-lg fa-fw mx-5px fa-trash-can text-danger c_trash"></i>
                                                                                    </a>
                                                                                </div>
                                                                                <div class="ms-2 row" style="width: 140px;">
                                                                                    <span >{{ pf.payment.payment_date.strftime('%d-%m-%Y %H:%M') if pf.payment.payment_date else '' }}</span>
                                                                                </div>
                                                                                <div class="ms-2 row" style="width: 100px;">
                                                                                    <!-- ‡πÉ‡∏™‡πà default ‡πÄ‡∏™‡∏°‡∏≠‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á term.id -->
                                                                                    {% set ns = namespace(total_paid=0.0) %}
                                                                                        {% if payment_file_list %}
                                                                                            {% for pf in payment_file_list %}
                                                                                                {% set ns.total_paid = ns.total_paid + (pf.payment.amount or 0) %}
                                                                                            {% endfor %}
                                                                                        {% endif %}
                                                                                        <input type="hidden" name="paid_amount" data-term-id="{{ term.id }}"
                                                                                            value="{{ '%.2f' % ns.total_paid }}">

                                                                                    <span>{{ '{:,.2f}'.format(pf.payment.amount or 0) }}</span>
                                                                                </div>
                                                                                
                                                                            </div>
                                                                        {% endfor %}
                                                                    {% else %}
                                                                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ</p>
                                                                    {% endif %}
                                                                    





                                                                </div>
                                                            </div>
                                                        
                                
                                                    </div>
                                                    
                                                </div>
                                            </div>
                                            
                                            
                                        </div>
                                            
                                        {%endfor%}
                                    </div>

                                    <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° -->
                                    <div class="row mt-2" >
                                        <div class="col-md-4">
                                            <div class="row mt-3"  >
                                                <label class="form-label col-form-label col-md-5">Note</label>
                                                <div class="col-md-7">
                                                    <textarea class="form-control" id="i_note" rows="4" cols="50"  name="note" placeholder="" >{{datas.note}}</textarea>
            
                                                </div>
                                            </div>                                          
                                        </div>
                                        <div class="col-md-8">
                                            <div class="row g-2 align-items-center">
                                                <label class="col-md-2 col-form-label fw-bold text-end me-4">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</label>
                                
                                                <div class="col-md-2 ms-3">
                                                    <input type="text" class="form-control-plaintext text-end" name="sum_installments"
                                                        value="0" onchange="formatInputNumberWithCommas(this)">
                                                </div>
                                
                                                <div class="col-md-2 ">
                                                    <input type="text" class="form-control-plaintext text-end" name="sum_discount"
                                                        value="{{ '{:,.2f}'.format(datas.discount)}}" onchange="formatNumberWithCommas(this)">
                                                </div>
                                
                                                <div class="col-md-2 me-3">
                                                    <input type="text" class="form-control-plaintext text-end" name="total_payment"
                                                    value="" readonly placeholder="‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
                                                </div>
                                            </div>
                                            
                                            <div class="row mt-3"  hidden>
                                                <label for="term" class="form-label col-form-label col-md-5">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô  </label>
                                                <div class="col-md-7">
                                                    <select class="default-select2 form-control col-3" id="installment" name="cash_payment">
                                                        {% for payment in payments %}
                                                            <option value="installment_{{ loop.index }}" {% if datas.status == 'installment_' ~ loop.index %}selected{% endif %}>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏á‡∏ß‡∏î {{ loop.index }}</option>
                                                        {% endfor %}
                                                        <option value="cancelled" {% if datas.status == 'cancelled' %}selected{% endif %}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                                                        <option value="completed" {% if datas.status == 'completed' %}selected{% endif %}>‡∏à‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</option>
                                                    </select>
                                                </div>
                                            </div> 
                                            
                                        </div>
                                        
                                    </div>
                                </div>
                                
                                
                                

                                            
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    

</form>
<a href="javascript:;" class="btn btn-icon btn-circle btn-primary btn-scroll-to-top" data-toggle="scroll-to-top"><i class="fa fa-angle-up"></i></a>




{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script src="{{ config.ASSETS_ROOT }}/plugins/datatables.net/js/dataTables.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/datatables.net-bs5/js/dataTables.bootstrap5.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/js/demo/table-manage-responsive.demo.js"></script>

<script src="{{ config.ASSETS_ROOT }}/plugins/moment/min/moment.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/bootstrap-daterangepicker/daterangepicker.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/select2/dist/js/select2.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/bootstrap-datepicker/dist/js/bootstrap-datepicker.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/ion-rangeslider/js/ion.rangeSlider.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/jquery.maskedinput/src/jquery.maskedinput.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>



<script src="{{ config.ASSETS_ROOT }}/plugins/jquery-migrate/dist/jquery-migrate.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/tag-it/js/tag-it.min.js"></script>

<script src="{{ config.ASSETS_ROOT }}/plugins/clipboard/dist/clipboard.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/spectrum-colorpicker2/dist/spectrum.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/select-picker/dist/picker.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/js/demo/form-plugins.demo.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/js/demo/render.highlight.js"></script>

<script src="{{ config.ASSETS_ROOT }}/js/supplier/main_supplier.js?v1.0"></script>
<script>
    function checkExistingFiles(input, paymentId) {
        const existingFilesContainer = document.getElementById(`existing_files_${paymentId}`);
        //console.log('üì¶ paymentId:', paymentId);
        //console.log('üì¶ container:', existingFilesContainer);
        if (!existingFilesContainer) {
            //console.warn(`‡πÑ‡∏°‡πà‡∏û‡∏ö container: existing_files_${paymentId}`);
            // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ï‡πà‡∏≠
            return;
        }
    
        const existingFiles = existingFilesContainer.querySelectorAll('.attached-file');
       // console.log('üìÑ attached-file count:', existingFiles.length);
        if (existingFiles.length > 0) {
            check_fail('‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ö‡πÉ‡∏´‡∏°‡πà');
            input.value = ''; // ‡∏•‡πâ‡∏≤‡∏á input
            validateFile(input); // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ï‡πà‡∏≠
            return;
        }
        validateFile(input); 
        //console.log('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡πÄ‡∏î‡∏¥‡∏° -> ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏ö');
    }
</script>
<script>
    $("input[id^='kt_datepicker_']").each(function () {
        $(this).flatpickr({
            enableTime: true,
            dateFormat: "d-m-Y H:i", // ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö format ‡∏Ç‡∏≠‡∏á value ‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡πÉ‡∏ô input
            time_24hr: true,
            // minDate: "today" // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡πâ uncomment ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
        });
    });
    

    $('input.datepicker').datepicker({
        format: 'dd-mm-yyyy',
        autoclose: true,
        todayHighlight: true
    });
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á .input-group ‡πÅ‡∏•‡∏∞ icon
$('.input-group.date').on('click', function (e) {
    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏ã‡πâ‡∏≥
    if (!$(e.target).is('input')) {
        $(this).find('input.datepicker').datepicker('show');
    }
});
function triggerInitialCalculation() {
    $('input[name="installments"], input[name="discount"]').each(function () {
        $(this).trigger('input');
    });
}
let inputCount = 1;
$(document).ready(function () {
    console.log("jQuery loaded");
    triggerInitialCalculation() 
    let foundIndex = null;

  $('.accordion-item').each(function(index) {
    const outstandingInput = $(this).find('input[name="outstanding_amount"]');
    if (outstandingInput.length === 0) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ

    const outstanding = parseFloat(outstandingInput.val().replace(/,/g, '')) || 0;

    if (foundIndex === null && outstanding > 0.00) {
      foundIndex = index;
      return false; // ‡∏´‡∏¢‡∏∏‡∏î loop
    }
  });

  if (foundIndex !== null) {
    const $itemToOpen = $('.accordion-item').eq(foundIndex);
    const $button = $itemToOpen.find('.accordion-button');
    const $collapse = $itemToOpen.find('.accordion-collapse');

    $button.removeClass('collapsed').attr('aria-expanded', 'true');
    $collapse.addClass('show');
  }
    //--------- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì -----------------
    $(document).on('input', 'input[name="discount"]', function () {
        const termId = $(this).data('term-id');

        const installmentsInput = $(`input[name="installments"][data-term-id="${termId}"]`);
        const discountInput = $(`input[name="discount"][data-term-id="${termId}"]`);
        const totalInput = $(`input[name="count"][data-term-id="${termId}"]`);
        const outstanding_amountInput = $(`input[name="outstanding_amount"][data-term-id="${termId}"]`);
        const total_payInput = $(`input[name="total_pay"][data-term-id="${termId}"]`);
    
        if (
            installmentsInput.length === 0 ||
            discountInput.length === 0 ||
            totalInput.length === 0 ||
            outstanding_amountInput.length === 0 
        ) {
            console.warn(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö input ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á term ID: ${termId}`);
            return;
        }

        const paid_amountInput = $(`input[name="paid_amount"][data-term-id="${termId}"]`);
        const paidAmount = paid_amountInput.length > 0
            ? parseFloat((paid_amountInput.val() || "0").replace(/,/g, '')) || 0
            : 0;
    
        const installments = parseFloat((installmentsInput.val() || "0").replace(/,/g, '')) || 0;
        const discount = parseFloat((discountInput.val() || "0").replace(/,/g, '')) || 0;
        const paid_amount = parseFloat((paid_amountInput.val() || "0").replace(/,/g, '')) || 0;
        const total = parseFloat((installments - discount).toFixed(2));
    
        totalInput.val(total.toLocaleString('en-US', { minimumFractionDigits: 2 }));
        const outstanding = Math.max(0, parseFloat((total - paidAmount).toFixed(2)));  // ‚ùó ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏•‡∏ö


        //outstanding_amountInput.val(total.toLocaleString('en-US', { minimumFractionDigits: 2 }));
    
        //console.log(`‚úÖ term ${termId}: ${installments} - ${discount} = ${total}`);
        outstanding_amountInput.val(outstanding.toLocaleString('en-US', { minimumFractionDigits: 2 }));
        total_payInput.val(outstanding.toLocaleString('en-US', { minimumFractionDigits: 2 }));
        
        //console.log(`‚úÖ term ${termId}: ${installments} - ${discount} = ${total} ‚Üí -${paid_amount} = outstanding: ${outstanding}`);


        calculateTotalcount();
    });
    /*$('input[name="installments"], input[name="discount"]').on('input', function () {
        let row = $(this).closest('.row'); // ‡πÉ‡∏ä‡πâ closest('.row') ‡πÅ‡∏ó‡∏ô tr
    
        let installmentsInput = row.find('input[name="installments"]');
        let discountInput = row.find('input[name="discount"]');
        let totalInput = row.find('input[name="count"]'); // ‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏£‡∏ß‡∏°
    
        let installments = parseFloat(installmentsInput.val().replace(/,/g, '')) || 0;
        let discount = parseFloat(discountInput.val().replace(/,/g, '')) || 0;
    
        let total = installments - discount;
        total = parseFloat(total.toFixed(2));
    
        console.log("total",total)
        if (totalInput.length > 0) {
            totalInput.val(total.toLocaleString('en-US', { minimumFractionDigits: 2 }));
        }

        calculateTotalcount();
    });
    

    $('[id^="term-form-"]').each(function () {
        const row = $(this);
        const termId = row.attr('id').replace('term-form-', '');

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì total (installments - discount)
        row.find('input[name="installments"], input[name="discount"]').on('input', function () {
            let installmentsInput = row.find('input[name="installments"]');
            let discountInput = row.find('input[name="discount"]');
            let totalInput = row.find('input[name="count"]');

            let installments = parseFloat(installmentsInput.val().replace(/,/g, '')) || 0;
            let discount = parseFloat(discountInput.val().replace(/,/g, '')) || 0;

            let total = installments - discount;
            total = parseFloat(total.toFixed(2));

            if (totalInput.length > 0) {
                totalInput.val(total.toLocaleString('en-US', { minimumFractionDigits: 2 }));
            }
            console.log(total)
            calculateTotalcount(); // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        });

        
    });
*/

    $(`input[name="installments"]`).each(function () {
        calculateTotalInstallments();
        calculateTotalcount();
    });
    

    $(document).on('input', 'input[name="discount"]', function () {
        calculateTotalDiscount();
    });

    $('.row.mb-3.align-items-center').each(function () {
        calculatdiscountPayment($(this));
        //calculateTotalcount();
    });

    triggerInitialCalculation();
    function generateInputs(termValue, payments = []) {
        let termNumber = parseInt(termValue, 10); 
        let extraInputsContainer = $("#extra-inputs");

        extraInputsContainer.empty(); 

        if (!isNaN(termNumber) && termNumber > 0) { 
            for (let i = 0; i < termNumber; i++) {
                let defaultID = payments[i] ? payments[i].id : "";
                let defaultDetail = payments[i] ? payments[i].term_detail : "";
                let defaultAmount = payments[i] ? payments[i].amount : "";

                let newRow = `
                    <div class="row mb-15px">
                        <label class="form-label col-form-label col-md-4">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î ${i + 1}</label>
                        <div class="col-md-4">
                            <input type="text" class="form-control" hidden name="term_id" value="${defaultID}" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                            <input type="text" class="form-control" name="term_detail" value="${defaultDetail}" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control price-input" name="installments" value="${defaultAmount}" oninput="formatInputNumberWithCommas(this)" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î ${i + 1}">
                        </div>
                    </div>
                `;
                extraInputsContainer.append(newRow);
            }
        }
    }

    let payments = JSON.parse($("#paymentData").val() || "[]");

    let initialTermValue = $("#i_term").val();
    if (initialTermValue) {
        generateInputs(initialTermValue, payments);
    }

    $("#i_term").change(function () {
        let termValue = $(this).val().trim();
        generateInputs(termValue, payments);
    });

//----------------------------------------------------

    $('.addInputButton').click(function (e) {
        
        if (inputCount >= 5) {
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
            return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
        }

        inputCount++;
        console.log(inputCount)
        e.preventDefault();

            let newRow = `<div class="item-row">
                            <div class="form-group row">
                                <label class="form-label col-form-label col-lg-4">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠<span class="text-danger">*</span> </label> 
                            </div>
                            <div class="row mb-3">
                                <div class="col-lg-4 pe-0">
                                    <input type="text" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•*" name="name_coordinator" required/>
                                </div>
                                <div class="col-lg-4 pe-0">
                                    <input type="text" class="form-control" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•*" name="name_coordinatorEmail" required />
                                </div>
                                <div class="col-lg-3 pe-0">
                                    <input type="text" class="form-control" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£*" name="name_coordinatorTell" required />
                                </div>
                                <div class="col-lg-1">
                                    <a href="javascript:;" class="btn btn-sm btn-icon btn-danger text-center mt-1" onclick="func_deleteItem(this)">
                                        <i class="fa fa-minus text-center"></i>
                                    </a>
                                </div>
                            </div>
                        </div>`;
            
        $('#extra-inputs').append(newRow);
      
    });



    
   
    

    

      

});

function check_price(input){
    const $input = $(input);
    const $row = $input.closest('.accordion-body'); // ‡∏´‡∏£‡∏∑‡∏≠ .row ‡∏ñ‡πâ‡∏≤ input ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô .row ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô

    const amountInput = $row.find('input[name="amount"]');
    const countInput = $row.find('input[name="check_count"]');

    if (amountInput.length === 0 || countInput.length === 0) {
        console.warn('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö input amount ‡∏´‡∏£‡∏∑‡∏≠ count ‡πÉ‡∏ô DOM');
        return;
    }

    const amount = parseFloat((amountInput.val() || '0').replace(/,/g, '')) || 0;
    const count = parseFloat((countInput.val() || '0').replace(/,/g, '')) || 0;

   
    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡πÄ‡∏Å‡πà‡∏≤
    amountInput.next('.amount-error').remove();

    if (amount > count) {
        amountInput.after(`<small class="text-danger amount-error" style="font-size: 0.65rem;">‡πÄ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</small>`);

    }
}

function check_discounts(input){
    const $input = $(input);
    const $row = $input.closest('.accordion-header'); // ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô .row ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô .row

    const discountInput = $row.find('input[name="discount"]');
    const installmentsInput = $row.find('input[name="installments"]');
    const countInput = $row.find('input[name="count"]');

    const count = countInput

    if (discountInput.length === 0 || installmentsInput.length === 0) {
        console.warn('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö input discount ‡∏´‡∏£‡∏∑‡∏≠ outstanding_amount ‡πÉ‡∏ô DOM');
        return;
    }

    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡πÄ‡∏Å‡πà‡∏≤
    discountInput.next('.amount-error').remove();

    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ input ‡πÄ‡∏™‡∏£‡πá‡∏à (debounce)
    setTimeout(() => {
        let discount = parseFloat((discountInput.val() || '0').replace(/,/g, '').trim()) || 0;
        let installments = parseFloat((installmentsInput.val() || '0').replace(/,/g, '').trim()) || 0;

        console.log("discount", discount);
        console.log("installmentsInput", installmentsInput);

        if (discount > installments) {
            // ‡∏£‡∏µ‡πÄ‡∏ã‡∏ï‡πÄ‡∏õ‡πá‡∏ô 0.00
            //const count = countInput
            countInput.val("0.00");

            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            discountInput.after(`<small class="text-danger amount-error" style="font-size: 0.65rem;">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</small>`);
        }
    }, 100);
}


//  
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì count ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß
function calculatdiscountPayment(row) {
    let installmentsInput = row.find('input[name="installments"]');
    let discountInput = row.find('input[name="discount"]');
    let totalInput = row.find('input[name="count"]');

    let installments = parseFloat(installmentsInput.val()?.replace(/,/g, '')) || 0;
    let discount = parseFloat(discountInput.val()?.replace(/,/g, '')) || 0;

    let total = installments - discount;
    total = parseFloat(total.toFixed(2));

    console.log()

    if (totalInput.length > 0) {
        totalInput.val(total.toLocaleString('en-US', { minimumFractionDigits: 2 }));
    }
}
//  ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
function calculateTotalInstallments() {
    let total_installments = 0;

    $('input[name="installments"]').each(function () {
        const rawValue = $(this).val();
        if (typeof rawValue === 'string' && rawValue.trim() !== '') {
            const value = Number(rawValue.replace(/,/g, '')) || 0;
            total_installments += value;
        }
    });

    const $sumInput = $('input[name="sum_installments"]');
    if ($sumInput.length) {
            let formatted = formatNumberWithCommas(total_installments.toFixed(2));
            $sumInput.val(formatNumberWithCommas(total_installments.toFixed(2))).trigger('input');
            //$sumInput.val(total_installments.toFixed(2)).trigger('input');
    }
}

//  ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
function calculateTotalDiscount() {
    let total_discount = 0;

    $('input[name="discount"]').each(function () {
        const rawValue = $(this).val();
        if (typeof rawValue === 'string' && rawValue.trim() !== '') {
            const value = Number(rawValue.replace(/,/g, '')) || 0;
            total_discount += value;
        }
        //console.log(total_discount)
    });

    const $sumInputdiscount = $('input[name="sum_discount"]');
    if ($sumInputdiscount.length) {
            let formatted = formatNumberWithCommas(total_discount.toFixed(2));
            $sumInputdiscount.val(formatNumberWithCommas(total_discount.toFixed(2))).trigger('input');
    }
}

//  ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
function calculateTotalcount() {
    $('input[name="sum_installments"], input[name="sum_discount"]').on('input', function () {
        let row = $(this).closest('.row'); // ‡πÉ‡∏ä‡πâ closest('.row') ‡πÅ‡∏ó‡∏ô tr
    
        let installmentsInput = row.find('input[name="sum_installments"]');
        let discountInput = row.find('input[name="sum_discount"]');
        let totalInput = row.find('input[name="total_payment"]'); // ‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏£‡∏ß‡∏°
    
        let installments = parseFloat(installmentsInput.val().replace(/,/g, '')) || 0;
        let discount = parseFloat(discountInput.val().replace(/,/g, '')) || 0;
    
        let total_payment = installments - discount;
        total_payment = parseFloat(total_payment.toFixed(2));
    
        if (totalInput.length > 0) {
            totalInput.val(total_payment.toLocaleString('en-US', { minimumFractionDigits: 2 }));
        }

    });
    
}
function func_deleteItem(el) {

    $(el).closest('.item-row').remove();

     if (inputCount > 0) {
        inputCount--;
    }

    if ($('#extra-inputs .item-row').length === 0) {
        $('#extra-inputs').append(createContactRow());
        inputCount = 1;
    }
}

function removeInputIdEx() {
     const inputId = $(this).data('target'); // ‡∏î‡∏∂‡∏á ID ‡∏Ç‡∏≠‡∏á input ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏à‡∏≤‡∏Å data attribute
    // inputCount--;
    // ‡∏•‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô input ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
    $('#' + inputId).val(''); // ‡∏•‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á input
    

}  

function createContactRow() {
    return `
    <div class="item-row">
        <div class="form-group row">
            <label class="form-label col-form-label col-lg-4">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ <span class="text-danger">*</span></label> 
        </div>
        <div class="row mb-3">
            <div class="col-lg-4 pe-0">
                <input type="text" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•*" name="name_coordinator" required/>
            </div>
            <div class="col-lg-4 pe-0">
                <input type="text" class="form-control" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•*" name="name_coordinatorEmail" required />
            </div>
            <div class="col-lg-3 pe-0">
                <input type="text" class="form-control" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£*" name="name_coordinatorTell" required />
            </div>
            <div class="col-lg-1">
                <a href="javascript:;" class="btn btn-sm btn-icon btn-danger text-center mt-1" onclick="func_deleteItem(this)">
                    <i class="fa fa-minus text-center"></i>
                </a>
            </div>
        </div>
    </div>`;
}


function clearZeroWhenTyping(input) {
    if (input.value === "0.00") {
        input.value = "";
    }
}

function formatInputNumberWithCommasDiscount(input) {
    let value = input.value;

    // ‡∏•‡∏ö comma ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô
    value = value.replace(/,/g, '');

    let regex = /^\d+(\.\d{0,2})?$/;
    if (!regex.test(value)) {
        input.value = input.value.slice(0, -1); // ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å
        return;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    let number = parseFloat(value);

    // ‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
    let parts = value.split('.');
    parts[0] = parseInt(parts[0], 10).toLocaleString(); // ‡πÄ‡∏û‡∏¥‡πà‡∏° comma ‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤

    // ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö
    input.value = parts.length > 1 ? parts.join('.') : parts[0];
}

function formatInputNumberWithCommas(input) {
    
    if (!input || typeof input.value !== 'string') {
        return;
    }
    // ‡∏•‡∏ö comma ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô
    let value = input.value.replace(/,/g, '');

    let regex = /^\d+(\.\d{0,2})?$/;
    if (!regex.test(value)) {
        input.value = input.value.slice(0, -1); // ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å
        return;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    let number = parseFloat(value);

    // ‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
    let parts = value.split('.');
    parts[0] = parseInt(parts[0], 10).toLocaleString(); // ‡πÄ‡∏û‡∏¥‡πà‡∏° comma ‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤

    // ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö
    input.value = parts.length > 1 ? parts.join('.') : parts[0];
}

function formatNumberWithCommas(value) {
    if (value === null || value === undefined) return '';
    value = value.toString().replace(/,/g, '');

    if (isNaN(value)) return '';

    const parts = value.split('.');
    parts[0] = parseInt(parts[0], 10).toLocaleString();

    return parts.length > 1 ? parts.join('.') : parts[0];
}


function validateFile(input) {
    const allowedExtensions = ['jpg', 'jpeg', 'png']; // ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
    const file = input.files[0];

    if (file) {
        const fileExtension = file.name.split('.').pop().toLowerCase(); // ‡∏î‡∏∂‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏ü‡∏•‡πå

        if (!allowedExtensions.includes(fileExtension)) {
            check_fail('‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå JPG, JPEG, PNG ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!');
            input.value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ input
        }
    }
}

function formatNumberInter(input) {

    let value = input.value;

    // ‡∏•‡∏ö comma ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô
    value = value.replace(/,/g, '');

    let regex = /^\d+(\.\d{0,2})?$/;
    if (!regex.test(value)) {
        input.value = input.value.slice(0, -1); // ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å
        return;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    let number = parseFloat(value);

    // ‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
    let parts = value.split('.');
    parts[0] = parseInt(parts[0], 10).toLocaleString(); // ‡πÄ‡∏û‡∏¥‡πà‡∏° comma ‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤

    // ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö
    input.value = parts.length > 1 ? parts.join('.') : parts[0];
}


</script>
<script>
    function post(path, params, method = "post") {
        const form = document.createElement("form");
        form.method = method;
        form.action = path;
        for (const key in params) {
            if (params.hasOwnProperty(key)) {
                const hiddenField = document.createElement("input");
                hiddenField.type = "hidden";
                hiddenField.name = key;
                hiddenField.value = params[key];
                form.appendChild(hiddenField);
            }
        }
        document.body.appendChild(form);
        form.submit();
    }
    
    function func_save() {
        // console.log("Saving...");
    
        $('#myForm').attr('action', '/order/save_payment').attr('method', 'POST');
        $('#myForm').submit();
    }
    
    // let inputIds = [];
    
    let inputIds = [];
    
    $('#myForm').submit(function(e) {
        e.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ submit ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥
    
        let isValid = true;
       
        if (isValid) {
            // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend:
            // $('#myForm').attr('action', route).attr('method', 'POST');
            this.submit(); // ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ submit ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏£‡∏¥‡∏á
        }
    });

    
    
    function validateForm() {
        let isValid = true;
    
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å input, textarea, select ‡∏ó‡∏µ‡πà required
        $('#myForm').find('input[required], textarea[required], select[required]').each(function () {
            if (!$(this).val().trim()) {
                $(this).addClass('border-red-500');
                isValid = false;
            } else {
                $(this).removeClass('border-red-500');
            }
        });
        /*
        if (!isValid) {
            swal({
                icon: 'warning',
                title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
            });
            return;
        }
        */
        // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        func_save();
    }
</script>
<script>
    
function sweetAlertDelfile(id_file,id_order) {
    swal({
        title: "Are you sure?",
        text: "Delete?",
        icon: "error",
        buttons: {
            cancel: {
                text: "Cancel",
                value: null,
                visible: true,
                className: "btn btn-dark",
                closeModal: true,
            },
            confirm: {
                text: "Yes, Delete.",
                value: true,
                visible: true,
                className: "btn btn-danger",
                closeModal: true,
            },
        },
    }).then((result) => {
        if (result.dismiss !== "cancel") {
            post("/order/delete_file", {
                id_file: id_file,
                id_order: id_order,
                // path: $("#path").val(),
            });
        }
    });
}
</script>
<script>
    $('input[id^="installments"],input[id^="discount"]' ).on('input', function () {
        let row = $(this).closest('tr'); // ‡∏î‡∏∂‡∏á‡πÅ‡∏ñ‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        let installmentsInput = row.find('input[id^="installments"]');
        let discountInput = row.find('input[id^="discount"]');

        let installments = parseFloat(installmentsInput.val().replace(/,/g, '')) || 0;
        let discount = parseFloat(discountInput.val().replace(/,/g, '')) || 0;

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì total_cost ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö n_cost
        
        let total = installments - discount;
        total = parseFloat(total.toFixed(2)); 

        // console.log("totalCost")
        // console.log(totalCost)
            // row.find('input[id^="sum_cost"]').val(formatNumberWithCommas(totalCost));
        row.find('input[id^="total"]').val(total);
        
    });
</script>
<script>
    
    function saveSingleTerm(termId,x) {
        var container = $(`#term-form-${termId}`);  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å form ‡∏ï‡∏≤‡∏° termId
        var paymentDate = container.find('input[name="payment_dates"]').val() || '';
        var amount = container.find('input[name="amount"]').val() || 0;
        var total_pay = container.find('input[name="total_pay"]').val() || 0;
        var fileInput = container.find('input[name="formFile_payment"]')[0]; // [0] ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤ DOM element

        var rawAmount = container.find('input[name="amount"]').val() || '';
        var amount = rawAmount.replace(/,/g, '').trim();

        var rawTotalPat = container.find('input[name="total_pay"]').val() || '';
        var total_pay = rawTotalPat.replace(/,/g, '').trim();

        const $btn = $(x);
        $btn.prop("disabled", true);

        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        if (!paymentDate) {
            alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô");
            return;
        }

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
            alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            return;
        }
        // ‚úÖ Validate ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
            alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô");
            return;
        }

        var formData = new FormData();
        formData.append('term_ids', termId);
        formData.append('payment_date', paymentDate);
        formData.append('amount', amount);
        formData.append('total_pay', total_pay);

        if (fileInput && fileInput.files && fileInput.files.length > 0) {
            formData.append('formFile_payment', fileInput.files[0]);
        }
        // Debug ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• formData
        for (const pair of formData.entries()) {
            console.log(pair[0], pair[1]);
        }
    
        fetch("/order/save_single_term", {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                swal({
                    icon: 'success',
                    title: '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                }).then(() => {
                    location.reload(); // ‚úÖ ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ reload ‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î modal
                });
            } else {
                check_fail("‚ùå " + data.error);
                $btn.prop("disabled", false);
            }
        })
        .catch(err => {
            check_fail("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
        });
    }
    
    
</script>

{% endblock javascripts %}
