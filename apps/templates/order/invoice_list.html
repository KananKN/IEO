{% extends "layouts/base.html" %}

{% block title %} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<link href="{{ config.ASSETS_ROOT }}/plugins/datatables.net-bs5/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/select2/dist/css/select2.min.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/tag-it/css/jquery.tagit.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/select-picker/dist/picker.min.css" rel="stylesheet" />
<link rel="preload" as="image" href="/static/assets/img/logo/logo-ieo.png">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
    .print-receipt-btn {
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;               /* ‡πÉ‡∏ä‡πâ flexbox */
        align-items: center;         /* ‡∏à‡∏±‡∏î‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        justify-content: center;     /* ‡∏à‡∏±‡∏î‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
      }
      
      .print-receipt-btn i.material-icons {
        font-size: 18px;
        line-height: 1;
      }
  </style>
{% endblock stylesheets %}

{% block content %}

<div id="content" class="app-content">

    <h1 class="page-header">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à 
        {% if current_user.has_permission('write_account') %}
            
        {% endif %}
    </h1>
    
    <div class="row">
        <div class="col-xl-12">
            <div class="panel panel-inverse">
                <div class="panel-heading">
                    <h4 class="panel-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à </h4>
                    <div class="panel-heading-btn">
                        <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>
                        <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload"><i class="fa fa-redo"></i></a>
                        <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse"><i class="fa fa-minus"></i></a>
                        <a href="javascript:;" class="btn btn-xs btn-icon btn-danger" data-toggle="panel-remove"><i class="fa fa-times"></i></a>
                    </div>
                </div>
                <div class="panel-body">
                    
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for categorie, message in messages %}
                                <div class="alert alert-{{categorie}} alert-dismissible fade show mb-2 mt-1">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}                    
                        {% endif %}
                    {% endwith %}
                    <div class="row mb-3 align-items-center">
                      <div class="col-md-3">
                        <label for="productFilter" class="col-form-label py-0">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
                          <select id="productFilter" class="form-select">
                              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                              <!-- ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏° option ‡∏à‡∏≤‡∏Å backend -->
                          </select>
                      </div>
                      <div class="col-md-3">
                        <label>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</label>
                        <input type="text" id="startDateTime" class="form-control datetimepicker" placeholder="YYYY-MM-DD HH:mm:ss">
                      </div>
                      <div class="col-md-3">
                        <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</label>
                        <input type="text" id="endDateTime" class="form-control datetimepicker" placeholder="YYYY-MM-DD HH:mm:ss">
                      </div>
                      <div class="col-md-3">
                        <label>&nbsp;</label><br>
                        <button id="btnFilter" class="btn btn-primary">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                      </div>
                    </div>
                    
                    <table id="data-table-responsive" width="100%" class="table table-striped table-bordered align-middle text-nowrap">
                        <thead>
                            <tr>
                                <th width="1%">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                <th class="text-nowrap ">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                <th class="text-nowrap">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                <th class="text-nowrap">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</th>
                                <!-- <th class="text-nowrap w-150px">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th class="text-nowrap">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</th> -->
                                <th class="text-nowrap w-150px">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</th>
                                <th class="text-nowrap w-150px">VAT</th>
                                <th class="text-nowrap w-150px">‡∏£‡∏ß‡∏°‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th class="text-nowrap">‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th class="text-nowrap">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<a href="javascript:;" class="btn btn-icon btn-circle btn-primary btn-scroll-to-top" data-toggle="scroll-to-top"><i class="fa fa-angle-up"></i></a>

<iframe id="receipt-preview-frame" style="width: 100%; height: 1200px; border: 1px solid #ccc; margin-top: 20px;display:none;" hidden></iframe>{% for term in orderTerms %}
    <!-- templates/receipt_partial.html -->
{% set tax_for_term = tax | selectattr("terms_id", "equalto", term.id) | list %}
{% if tax_for_term %}
  {% for r in tax_for_term %}
<div id="invoice-content-{{ term.id }}" hidden style="page-break-inside: avoid; break-inside: avoid;">
    <!-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å backend ‡πÄ‡∏ä‡πà‡∏ô data.customer_name) -->
    <div style="display: table; width: 100%;">
  
      <!-- ‡πÇ‡∏•‡πÇ‡∏Å‡πâ (‡∏ã‡πâ‡∏≤‡∏¢) -->
      <div style="display: table-cell; width: 125px; vertical-align: top;">
        <img src="/static/assets/img/logo/logo-ieo.png"
             alt="Logo"
             style="width: 120px; height: auto;">
      </div>
    
      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡∏Ç‡∏ß‡∏≤) -->
      <div style="display: table-cell; text-align: right; padding-left: 20px; vertical-align: top;">
        <div>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏≠.‡∏≠‡∏µ.‡πÇ‡∏≠. ‡∏à‡∏≥‡∏Å‡∏±‡∏î</div>
        <div>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 80 ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÄ‡∏Ñ.‡πÄ‡∏≠.‡πÄ‡∏≠‡πá‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 104 ‡∏ä‡∏±‡πâ‡∏ô 1</div>
        <div>‡∏ã‡∏≠‡∏¢‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™‡∏£‡∏≤‡∏ä‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå 8 ‡πÅ‡∏Ç‡∏ß‡∏á‡∏ó‡∏∏‡πà‡∏á‡∏ß‡∏±‡∏î‡∏î‡∏≠‡∏ô</div>
        <div>‡πÄ‡∏Ç‡∏ï‡∏™‡∏≤‡∏ó‡∏£ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ 10120</div>
        <div>Tel. (66) 26426131-2 Fax. (66) 26426133</div>
        <div>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ 0-1055-42074-69-2 (‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà) </div>
      </div>
    
    </div>
    

    <div style="display: flex; justify-content: end; align-items: center; margin-bottom: 10px;">
        
        <table style="width: 50%; table-layout: fixed;">
          <tr>
            <td style="border: 1px solid black; width: 250px; text-align: center; vertical-align: middle; padding: 8px;background-color: black; color: white;">
              <h2 style="margin: 0;">Tax Invoice/Receipt</h2>
              <div>‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
            </td>
            <td style="border: 1px solid black; width: 150px; text-align: center; vertical-align: middle; padding: 8px;">
              <div>‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö / Original</div>
              <hr style="margin: 4px 0;">
              <h4 style="margin: 0 0;">{{ r.tax_invoice_no }}</h4>
              <div>(‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î)</div>
            </td>
          </tr>
        </table>
        
    </div>
    
  
    <div style="border: 2px solid black; margin-bottom: 5px;">
        <div style="display: flex; justify-content: space-between;">
          <div style="width: 50%;border-right: 2px solid black;">
            <div class="row" style="margin-left: 10px;padding-top:10px">
              <div class="col-4 ">
                <div style="margin: 10px">
                  <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</strong> <br>
                  Customer Name
                </div>
  
              </div>
              <div class="col-8" style="margin: 10px">
                {{r.member.first_name}} {{r.member.last_name}}  
              </div>

            </div>
            <div class="row" style="padding-left: 10px;">
              <div class="col-4">
                <div style="margin:10px">
                  <strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ</strong> <br>
                  Tax ID 
                </div>
  
              </div>
              <div class="col-8">
                
              </div>

            </div>
            <div class="row" style="padding-left: 10px;">
              <div class="col-4">
                <div style="margin: 10px;">
                  <strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</strong> <br>
                  Address
                </div>
  
              </div>
              <div style="flex: 1; word-break: break-word;margin-top: 10px;margin-left: 50px;">
                {{r.member.address}} 
              </div>

            </div>
          </div>
          <div style="width: 50%;">
            <!-- ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô: ‡πÅ‡∏ö‡πà‡∏á 2 ‡∏ù‡∏±‡πà‡∏á -->
            <div style="display: flex; width: 100%;">
              
              <!-- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢ -->
              <div style="display: table-cell; width: 50%; vertical-align: top; padding-right: 16px;border-right: 2px solid black;border-bottom: 2px solid black;">
                <div style="margin-bottom: 12px;padding-left: 10px;padding-top: 10px;">
                  <strong style="margin-right: 26px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> {% if r.transfer_date %}
                  {{ r.transfer_date.strftime('%Y-%m-%d') }}
                {% else %}
                  -
                {% endif %}<br>
                  <small>Issue Date</small>
                </div>
                <div style="margin-bottom: 12px;padding-left: 10px; padding-top: 10px;">
                  <strong>‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢:</strong> ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô<br>
                  <small>Payment</small>
                </div>
              </div>

              <!-- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏ß‡∏≤ -->
              <div style="display: table-cell; width: 50%; vertical-align: top; padding-left: 16px;padding-top: 10px;border-bottom: 2px solid black;">
                <div style="display: flex; gap: 8px; align-items: flex-start; margin-bottom: 5px;">
                    <!-- ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢: ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ + Salesman -->
                    <div style="white-space: nowrap;">
                      <strong>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢:</strong><br>
                      <small>Salesman</small>
                    </div>
                  
                    <!-- ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
                    <div style="flex: 1; word-break: break-word;font-size: 14px">
                      {{ r.order.agency.first_name }} {{ r.order.agency.last_name }}
                    </div>
                  </div>
                <div style="margin-bottom: 5px;">
                  <strong>‡πÉ‡∏ö‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•:</strong> {{ r.invoice_no or '-' }}<br>
                  <small>Invoice No</small>
                </div>
                <div style="margin-bottom: 5px;padding-top: 10px;">
                  <strong>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:</strong> {{ r.ref_doc or '-' }}<br>
                  <small>Ref Document</small>
                </div>
              </div>

            </div>

            <!-- ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á: Project Name -->
            <div style="display: table-row;">
              <div style="display: table-cell; padding-top: 12px;padding-left: 10px;padding-bottom:10px" colspan="2">
                <strong style="margin-right: 15px;">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ:</strong> {{ r.order.product.name or '-' }}<br>
                <small>Project Name</small>
              </div>
            </div>
            
              
            
            
          </div>
        </div>
      </div>
    
      <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
      <div class="section">
        <table>
          <thead style="background-color: black; color: white;">
            <tr>
              <th style="text-align: center; vertical-align: middle;font-size: 14px">
                ‡∏•‡∏≥‡∏î‡∏±‡∏ö <br>No.
              </th>
              <th style="text-align: center; vertical-align: middle;width: 325px;font-size: 14px">
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <br> Description
              </th>
              <th style="text-align: center; vertical-align: middle;font-size: 14px">
                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <br> Quatity
              </th>
              <th style="text-align: center; vertical-align: middle;font-size: 14px">
                ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡∏∞ <br> Unit Price
              </th>
              <th style="text-align: center; vertical-align: middle;font-size: 14px">
                ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î <br> Discount
              </th>
              <th style="text-align: center; vertical-align: middle;font-size: 14px">
                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô <br>(THB)
              </th>
            </tr>
          </thead>
          <tbody>
            <tr style="height: 185px;vertical-align: top;font-size: 14px">
              <td style="text-align: center;font-weight: normal; ">1</td>
              
              <td style="white-space: normal; word-break: break-word;">
                {{ r.order.product.name }} 
                {% set seq = term.sequence %}
                {% set suffix = 'th' %}
                {% if seq == 1 %}
                  {% set suffix = 'st' %}
                {% elif seq == 2 %}
                  {% set suffix = 'nd' %}
                {% elif seq == 3 %}
                  {% set suffix = 'rd' %}
                {% endif %}
                {{ seq }}{{ suffix }} Payment{% if seq == 1 %} ( Non Refundable1 ){% endif %}
              </td>
              
              <th style="text-align: center;font-weight: normal; ">
                1</td>
                <th class="right" style="font-weight: normal;">{{ '{:,.2f}'.format(term.amount)}}</td>
              <td class="right">{{ '{:,.2f}'.format(term.discount)}}</td>
              <td class="right">{{ '{:,.2f}'.format(term.net_price)}}</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- ‡∏Å‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏ç‡πà -->
    <table style="width: 100%; border-collapse: separate; border-spacing: 0; border: none;margin-top:5px;">

      <tr valign="top" style="border: none;">
      <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
      <td style="width: 50%; padding-right: 16px;border: none;vertical-align: middle;">
        <div style="margin-bottom: 8px;">
          <strong>‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</strong> <span style="font-size: 16px;">(Conditions of Payment)</span>
        </div>

        <div style="margin-bottom: 12px; display: flex; gap: 24px;">
          <div style="min-width: 120px; display: flex; align-items: center; gap: 8px;">
            <div style="font-size: 30px;margin-right:20px">&#x2610;</div>
            <div>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î<br><span style="font-size: 12px; color: #666;">Cash</span></div>
          </div>
          <div style="min-width: 120px; display: flex; align-items: center; gap: 8px;">
            <div style="font-size: 30px;margin-right:20px">&#x2611;</div>
            <div>‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô<br><span style="font-size: 12px; color: #666;">Bank Transfer </span></div>
          </div>
        </div>
        
        <div style="margin-bottom: 4px;display: flex; align-items: center; gap: 8px;">
        <div>
            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î<br><span style="font-size: 12px; color: #666;">Payment Detail</span>
          </div>
          <div style="white-space: normal; word-break: break-word;font-size: 13px;">
            ‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏≠.‡∏≠‡∏µ.‡πÇ‡∏≠. ‡∏à‡∏≥‡∏Å‡∏±‡∏î (INT) ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {% if r.transfer_date %}
            {{ r.transfer_date.strftime('%Y-%m-%d') }}
          {% else %}
            -
          {% endif %}
          </div>
        </div>
        
      </td>

      <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -->
      <td style="width: 35%; padding-left: 16px;border: none;">
        <div style="margin-bottom: 10px;line-height: 1.6;">
          <span >‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span><br>
          <span style="font-size: 12px; color: #666;">Subtotal</span><br>
          
        </div>
        <div style="margin-bottom: 10px">
          <span>‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©</span><br>
          <span style="font-size: 12px; color: #666;">Special Discount</span><br>
          
        </div>
        <div style="margin-bottom: 10px">
          <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span><br>
          <span style="font-size: 12px; color: #666;">Total</span><br>
          
        </div>
        <div style="margin-bottom: 10px">
          <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° 7%</span><br>
          <span style="font-size: 12px; color: #666;">Value Added Tax</span><br>
          
        </div>
        <div >
          <span>‡∏£‡∏ß‡∏°‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span><br>
          <span style="font-size: 12px; color: #666;">Subtotal</span><br>
          
        </div>
      </td>
      
      <td style="width: 15%; margin-top: 5px; padding-right: 0px; font-size: 14px; text-align: right;border: none;">

        <div style="border: 1px solid #000; padding: 10px; font-size: 14px; height: 25px; line-height: 20px;width:75px; margin-left: auto;">
            {{ '{:,.2f}'.format(term.amount) }}
        </div>  
        <div style="border: 1px solid #000; padding: 10px; font-size: 14px; height: 25px; line-height: 20px;width:75px; margin-left: auto;">
            {{ '{:,.2f}'.format(term.discount)}} 
        </div>      
        <div class="black-bg" style="border: 1px solid #000; padding: 10px;font-size: 14px;background-color: black; color: white;height: 25px; line-height: 20px;width:75px; margin-left: auto;">
            {{ '{:,.2f}'.format(term.net_price)}} 
        </div>      
        <div style="font-size: 14px; margin-top: 25px;height: 20px; line-height: 20px;">
          {{ '{:,.2f}'.format(r.vat)}} 
        </div>     
        <div style="font-size: 14px; margin-top: 25px;height: 20px; line-height: 20px;">
          {{ '{:,.2f}'.format(r.amount_before_vat)}} 
        </div>      
        </div>      
      </td>
    </tr>
  </table>

  <table style="width: 100%; table-layout: fixed;">
    <tr>
      <td style="width: 33.33%; text-align: center; vertical-align: top;">
        <div style="margin-top: 30px;">
          <div style="border-bottom: 1px dashed #000; width: 80%; margin: 80px auto 0;"></div>
          <div style="font-size: 14px; margin-top: 4px;">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / Bill Receiver Signature</div>
          <div style="font-size: 14px; margin-top: 10px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / Date .........................</div>
        </div>
      </td>
  
      <td style="width: 33.33%;"></td>
  
      <td style="width: 33.33%; text-align: center; vertical-align: top;">
        <div style="margin-top: 30px;">
          <div style="border-bottom: 1px dashed #000; width: 80%; margin: 80px auto 0;"></div>
          <div style="font-size: 14px; margin-top: 4px;">‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏•‡∏á‡∏ô‡∏≤‡∏° / Authorized Signature</div>
          <div style="font-size: 14px; margin-top: 10px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / Date .........................</div>
        </div>
      </td>
    </tr>
  </table>



      
    </div>
    {% endfor %}
    
  {% endif %}
{% endfor %}


{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<script src="{{ config.ASSETS_ROOT }}/plugins/datatables.net/js/dataTables.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/datatables.net-bs5/js/dataTables.bootstrap5.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/js/demo/table-manage-responsive.demo.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/moment/min/moment.min.js"></script>


<script src="{{ config.ASSETS_ROOT }}/plugins/parsleyjs/dist/parsley.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/@highlightjs/cdn-assets/highlight.min.js"></script>

<script src="{{ config.ASSETS_ROOT }}/plugins/select2/dist/js/select2.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/jquery-migrate/dist/jquery-migrate.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/tag-it/js/tag-it.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/select-picker/dist/picker.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/sweetalert/dist/sweetalert.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="{{ config.ASSETS_ROOT }}/js/order/main_orderList.js?v1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  let datatable; // <-- ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ access ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô

$(document).ready(function() {
  flatpickr(".datetimepicker", {
    enableTime: true,
    dateFormat: "d-m-Y H:i:S",
    time_24hr: true
  });
 
  
  $('#btnFilter').on('click', function(e) {
    e.preventDefault();
    datatable.ajax.reload();
  });

  $('#productFilter').select2({
    placeholder: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
    allowClear: true,
    width: 'resolve'
  });

  $('#productFilter').on('change', function () {
    const selectedProductId = $(this).val();
    console.log("‚úÖ Sending product_id:", selectedProductId);
    datatable.ajax.reload(); // ‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global datatable
  });
  
  $.get("/order/get_product_list", function (products) {
    products.forEach(product => {
      $("#productFilter").append(
        `<option value="${product.id}">${product.name}</option>`
      );
    });
  });
  

    loadDataTable();

    
});




function loadDataTable() {
    if ($.fn.DataTable.isDataTable('#data-table-responsive')) {
        $('#data-table-responsive').DataTable().destroy(); // ‡∏•‡∏ö DataTable ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô
    }

    datatable = $('#data-table-responsive').DataTable({
        responsive: true,
        processing: true,
        serverSide: true,
        ajax: {
            url: "/order/get_invoice",
            type: "POST",
            data: function(d) { 
                //d.product_id = $('#productFilter').val();
                const product_id = $('#productFilter').val();
                const start_datetime = $('#startDateTime').val();
                const end_datetime = $('#endDateTime').val();

                console.log("üì§ start_datetime:", start_datetime);
                console.log("üì§ end_datetime:", end_datetime);
                
                return JSON.stringify({
                  draw: d.draw,
                  start: d.start,
                  length: d.length,
                  search: d.search,
                  order: d.order,
                  product_id: $('#productFilter').val(),
                  start_datetime: $('#startDateTime').val(),
                  end_datetime: $('#endDateTime').val()
                });
            },
            contentType: "application/json",
            dataType: "json"
        },
        columns: [
            { data: "id" },
            { data: "tax_invoice_no" },
            { data: "customer_name" },
            { data: "product_name" },
            //{ data: "amount", className: "text-end", render: data => parseFloat(data).toLocaleString("en-US", { minimumFractionDigits: 2 }) },
            //{ data: "discount", className: "text-end", render: data => parseFloat(data).toLocaleString("en-US", { minimumFractionDigits: 2 }) },
            { data: "net_price", className: "text-end", render: data => parseFloat(data).toLocaleString("en-US", { minimumFractionDigits: 2 }) },
            { data: "vat", className: "text-end", render: data => parseFloat(data).toLocaleString("en-US", { minimumFractionDigits: 2 }) },
            { data: "amount_before_vat", className: "text-end", render: data => parseFloat(data).toLocaleString("en-US", { minimumFractionDigits: 2 }) },
            {
              data: "created_at",
              render: {
                display: data => data ? moment(data).format("DD/MM/YYYY HH:mm") : "-",
                sort: data => data // ‡πÉ‡∏ä‡πâ timestamp ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á
              }
            },        
            { 
                data: null,  

                orderable: false,  //‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡∏µ‡πâ
                render: function(data, type, row) {
                    const termId = row.term_id || '';

                    let buttons = '';
                
                    {% if current_user.has_permission('write_account') %}
                    buttons += `
                        <a class="btn btn-danger btn-icon btn-circle" onclick="sweetAlertDel(${row.data_user.id})" hidden>
                            <i class="fas fa-trash"></i>
                        </a>
                        <a href="#" class="btn btn-primary btn-icon btn-circle print-receipt-btn" data-term-id="${termId}">
                            <i class="material-icons">print</i>
                        </a>
                    `;
                    {% endif %}
                
                    return buttons;
                }
                
            }
        ],
        order: [[7, "asc"]],  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å ID
        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
        pageLength: 10
    });

    
}

</script>
<script>
    class ReceiptPrinter {
        constructor(receiptElement = null, invoiceElement = null) {
          this.receiptElement = receiptElement;
          this.invoiceElement = invoiceElement;
        }
      
        getPrintableHTML() {
          let combinedHTML = '';
          if (this.receiptElement) {
            combinedHTML += `<div style="page-break-after: always;">${this.receiptElement.innerHTML}</div>`;
          }
          if (this.invoiceElement) {
            combinedHTML += `<div>${this.invoiceElement.innerHTML}</div>`;
          }
      
          return `
            <html>
            <head>
               <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet"> 
               <link rel="preload" as="image" href="/static/assets/img/logo/logo-ieo.png">
              <title>Invoice Print</title>
              <style>
                @font-face {
                    font-family: "Kanit";
                    font-weight: normal;
                    font-style: normal;
                 }
                body {
                  font-family: "Kanit", sans-serif;
                  width: 800px;
                  margin: 0 auto;
                  padding: 20px;
                  font-size: 16px !important;
                }
                table {
                  width: 100%;
                  border-collapse: collapse;
                  margin-top: 10px;
                }
                table, th, td {
                  border: 1px solid black;
                }
                td, th {
                  padding: 8px;
                  text-align: left;
                }
                .right { text-align: right; }
                .receipt-box {
                  border: 2px solid #000;
                  border-radius: 10px;
                  padding: 20px;
                  margin-top: 20px;
                }
                .row {
                  display: flex;
                  flex-wrap: wrap;
                  gap: 10px;
                  margin-bottom: 10px;
                }
                .col {
                  line-height: 1.5;
                }
                .col-15 { flex: 1.5; min-width: 80px; }
                .col-20 { flex: 2; min-width: 100px; }
                .col-25 { flex: 2.5; min-width: 150px; }
                .subtext {
                  font-size: 12px;
                  color: #666;
                  display: block;
                }
                .label { width: 75px; }
                .value { flex: 1; }
                .payment-print-block .row {
                  min-width: 225px;
                  display: flex;
                  gap: 10px;
                  margin-top: 4px;
                }
                @media print {
                    body {
                    font-family: 'Kanit', sans-serif !important;
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                    font-size: 14px !important;
                    }

                    div, table, td, th {
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                    }

                    table, tr, td, th {
                        page-break-inside: avoid !important;
                        break-inside: avoid !important;
                    }

                    .receipt-box {
                    border: 2px solid #000 !important;
                    }

                    /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
                    .black-bg {
                    background-color: black !important;
                    color: white !important;
                    }

                    /* ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö margin/padding ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå */
                    .no-print-margin {
                    margin: 0 !important;
                    padding: 0 !important;
                    }
                    .row, .col {
                    padding: 0 !important;
                    margin: 0 !important;
                    }
                    
                   
                }

              </style>
            </head>
            <body>${combinedHTML}</body>
          </html>
          `;
        }
      
        preview(previewIframeId = 'receipt-preview-frame') {
          const previewFrame = document.getElementById(previewIframeId);
          if (!previewFrame) {
            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö iframe ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö preview');
            return;
          }
          previewFrame.style.display = 'block';
      
          const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
          doc.open();
          doc.write(this.getPrintableHTML());
          doc.close();
          // ‚úÖ ‡∏£‡∏≠‡∏à‡∏ô DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
  previewFrame.onload = () => {
    const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
    const images = iframeDoc.images;

    if (images.length === 0) {
      previewFrame.contentWindow.focus();
      previewFrame.contentWindow.print();
      return;
    }

    let loaded = 0;
    for (let img of images) {
      if (img.complete) {
        loaded++;
      } else {
        img.onload = img.onerror = () => {
          loaded++;
          if (loaded === images.length) {
            previewFrame.contentWindow.focus();
            previewFrame.contentWindow.print();
          }
        };
      }
    }

    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏£‡∏Å
    if (loaded === images.length) {
      previewFrame.contentWindow.focus();
      previewFrame.contentWindow.print();
    }
  };
        }
      
        print() {
          const previewFrame = document.getElementById('receipt-preview-frame');
          if (!previewFrame) {
            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö iframe ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå');
            return;
          }
      
          const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
          doc.open();
          doc.write(this.getPrintableHTML());
          doc.close();
      
          previewFrame.onload = () => {
            const images = previewFrame.contentDocument.images;
            if (images.length === 0) {
              previewFrame.contentWindow.focus();
              previewFrame.contentWindow.print();
              return;
            }
        
            let loaded = 0;
            for (let img of images) {
              if (img.complete) {
                loaded++;
              } else {
                img.onload = img.onerror = () => {
                  loaded++;
                  if (loaded === images.length) {
                    previewFrame.contentWindow.focus();
                    previewFrame.contentWindow.print();
                  }
                };
              }
            }
        
            if (loaded === images.length) {
              previewFrame.contentWindow.focus();
              previewFrame.contentWindow.print();
            }
          };
        }
      }
      
  </script>
  
<script>

    $(document).on('click', '.print-receipt-btn', function (e) {
        e.preventDefault();
    
        const termId = $(this).data('term-id');
    
        // ‚úÖ ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ invoice
        const invoiceEl = document.getElementById(`invoice-content-${termId}`);
        console.log(invoiceEl);

        if (!invoiceEl) {
          alert(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ (invoice-content-${termId})`);
          return;
        }
    
        // ‚ùå ‡∏≠‡∏¢‡πà‡∏≤‡∏°‡∏µ receiptEl ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ
        // const receiptEl = document.getElementById(...); ‚Üê ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á
    
        const printer = new ReceiptPrinter(null, invoiceEl); // ‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        printer.print(); // ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ print ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
        
    });
    

</script>

{% endblock javascripts %}
