{% extends "layouts/base.html" %}

{% block title %} Product For Sales {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

<link href="{{ config.ASSETS_ROOT }}/plugins/datatables.net-bs5/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/select2/dist/css/select2.min.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/tag-it/css/jquery.tagit.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/select-picker/dist/picker.min.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/dropzone/dist/min/dropzone.min.css" rel="stylesheet" />
<script src="{{ config.ASSETS_ROOT }}/plugins/dropzone/dist/min/dropzone.min.js"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
          @media print {
            body,page {
            float: left;
            margin: none;
            box-shadow: 0;
            width: 85mm;
            height: 100%;
            }}

          .select2-container--default .select2-results__option[aria-disabled=true] {
                color: #999;
            }
            .datepicker-months .datepicker-switch,
            .datepicker-months th.next,
            .datepicker-months th.prev {
                display: none !important; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏®‡∏£ */
            }

            .default-select2 option {
                white-space: nowrap;       /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡πâ‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
                overflow: hidden;          /* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô */
                text-overflow: ellipsis;   /* ‡πÄ‡∏û‡∏¥‡πà‡∏° '...' ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô */
            }
            #priceTable {
                table-layout: fixed;
                width: auto !important; 
                border-collapse: collapse;
              }
              
              #priceTable th,
              #priceTable td {
                width: 125px;
                min-width: 125px;
                max-width: 125px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                border-bottom: 1px solid #ccc;   /* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏µ‡∏î‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô */
                border-top: none;
                border-left: none;
                border-right: none;
                text-align: center;
                padding: 6px 8px;
              }
              
              .table-responsive-horizontal {
                overflow-x: auto;
                width: 100%;
              }

              
            
             
    </style>
{% endblock stylesheets %}

{% block content %}
       
<!-- <form action="/order/add" id="myForm" method="POST" data-parsley-validate="true" enctype="multipart/form-data">-->
<form  id="myForm" data-parsley-validate="true" enctype="multipart/form-data" autocomplete="off"> 

<input type="text" name="fakefield" style="display:none">
<div id="content" class="app-content">

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for categorie, message in messages %}
            <div class="alert alert-{{categorie}} alert-dismissible fade show mb-2 mt-1">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}                    
    {% endif %}
{% endwith %}

    <div class="panel panel-default" data-sortable-id="ui-widget-11" data-init="true">
        <div class="panel-heading ui-sortable-handle">
            <h3 class="panel-title " style="font-size: 20px;">Product For Sales </h3>
            <div class="panel-heading-btn">
                <button type="button"  class="btn btn-blue"  onclick="func_save()">Save</button>
            </div>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-sm-6">
                    <div class="row mb-3" hidden>
                        <label class="form-label col-form-label col-md-4">id</label>
                        <div class="col-md-8">
                            <input type="text"  class="form-control" name="id" id="id-update" value="{{datas.id}}" data-parsley-required="true"/>
                        </div>
                    </div>    
                    <div class="row mb-3"  >
                        <label class="form-label col-form-label col-md-4">Name Product</label>
                        <div class="col-md-8">
                            <input  class="form-control"  name="name_product" id="i_nameProduct"  value="{{datas.name}}"  display data-parsley-required="true"/>
                        </div>
                    </div> 
                    <div class="row mb-3">
                        <label class="form-label col-form-label col-md-4">Product Category</label>
                        <div class="col-lg-8">
                            <select class="default-select2 form-control"  name="productCategory" id="i_productCategory" >
                                <option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                {% for productCar in productCars %}
                                    <option value="{{productCar.id}}" {% if datas.product_category_id|int == productCar.id|int %} selected {% endif %}>{{productCar.name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label class="form-label col-form-label col-md-4">Country</label>
                        <div class="col-lg-8">
                            <select class="default-select2 form-control"  name="country" id="i_country" >
                                <option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                {% for country in countrys %}
                                    <option value="{{country.id}}" {% if datas.country_id|int == country.id|int %} selected {% endif %}>{{country.name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <label class="form-label col-form-label col-md-4">Period</label>
                        <div class="col-lg-8">
                            <select class="default-select2 form-control"  name="period" id="i_period" >
                                <option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                {% for period in periods %}
                                    <option value="{{period.id}}" data-period="{{period.name}}" {% if datas.period_id|int == period.id|int %} selected {% endif %}>{{period.name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group row mb-3" hidden>
                        <label class="form-label col-form-label col-lg-4">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                            <div class="col-lg-8">
                                <div class="input-group input-daterange">
                                    <input type="text" class="form-control" name="start" id="w_start" placeholder="Date Start" required autocomplete="off" value="{{ datas.start_at.strftime('%d-%m-%Y') if datas.start_at else '' }}" />
                                    <span class="input-group-text input-group-addon">to</span>
                                    <input type="text" class="form-control" name="end" id="w_end"placeholder="Date End" required autocomplete="off" value="{{ datas.end_at.strftime('%d-%m-%Y') if datas.end_at else '' }}"/>
                                </div>
                            </div>
                    </div>
                    

                    <div class="form-group row">
                        <label class="form-label col-form-label col-lg-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                        <div class="col-lg-8">
                            <textarea class="form-control" id="detail" rows="4" cols="50"  name="detail" placeholder="" >{{datas.detail}}</textarea>
                        </div>
                    </div> 

                   

                </div>  
                <div class="col-sm-6">
                    <div class="row mb-15px">
                        <label class="form-label col-form-label col-md-4">‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <div class="col-md-8">
                           <!-- ‡∏™‡πà‡∏ß‡∏ô Input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå -->
                            <input 
                                class="form-control" type="file" id="formFile_img" name="formFile_img"  
                                accept=".jpg, .jpeg, .png" onchange="validateFile(this)" 
                            />

                            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
                            <div class="w-100px h-100px bg-light d-flex align-items-center justify-content-center me-2 mt-2">
                                {% if datas.images and datas.images|length > 0 %}
                                    <div class="col-2 rounded border mt-1 p-1 position-relative" style="width: 100px; height: 100px;">
                                        <a href="/static/assets/img/product/{{ datas.images[0].image }}" data-lightbox="gallery-group-4">
                                            <img src="/static/assets/img/product/{{ datas.images[0].image }}" 
                                                class="img-thumbnail" 
                                                alt="Image" 
                                                style="object-fit: cover; width: 100%; height: 100%; padding: 0 !important;">
                                        </a>
                                        <button type="button" onclick="sweetAlertDelImage({{ datas.images[0].id }}, event)" 
                                                class="btn btn-danger btn-icon btn-circle position-absolute"
                                                style="bottom: 5px; right: 5px;">
                                            <i class="fa fa-trash" style="font-size: 12px;"></i>
                                        </button>
                                    </div>
                                {% else %}
                                    <span>No Image</span>
                                {% endif %}
                            </div>

                        </div>
                    </div>
                    <div class="row mt-15px">
                        <label class="form-label col-form-label col-md-4">‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>

                        <div class="col-md-8">
                            <input class="form-control" type="file" id="formFile_file" name="formFile_file" multiple accept=".pdf,"  onchange="validateFile(this)"/>
                        </div>
                        {% for file_data in file_data %}
                            {% if file_data.file_type == 1 %}
                                <div class="row mt-2">
                                    <div class="col-md-4">
                                        
                                    </div>
                                    <div class="col-md-8 col-sm-12 col-xs-12 mt-10px text-ellipsis">
                                        <a href="{{ url_for('product_blueprint.downloadFile', filename=file_data.filename)}}" style="text-decoration: none; color: black;"><i class="fas fa-lg fa-fw ms-5px  fa-file"></i> <span>{{ file_data.filename }}</span></a> <a onclick="sweetAlertDelSign({{file_data.id}},{{datas.id}})"><i class="fas fa-lg fa-fw mx-5px fa-trash-can text-danger c_trash"></i></a>  </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                   
                   <div class="row mb-15px" hidden>
                        <label class="form-label col-form-label col-md-4">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô</label>
                        <div class="col-md-8">
                            <input  class="form-control"  name="cost" id="i_cost"  value=""  display data-parsley-required="true"/>
                        </div>
                    </div>
                   
                </div>
                                
            </div>
            <input type="" id="defaultProductYear"  hidden value="{{ datas.year }}">


            <hr class="my-3">
            <div class="row">
                <div class="col-sm-6">
                    <h5>Price List</h5>
                    <div class="row my-3" >
                        <label class="form-label col-form-label col-md-4">Year</label>
                        <input type="hidden" id="paymentData" value='{{ grouped_payments | tojson }}'>

                        <div class="col-md-4">
                            {% set default_year = datas.year %}
                            <select name="inputYear" id="inputYear" class="default-select2 form-control">
                                {% for year in range(2020, 2031) %}
                                    <option value="{{ year }}" {% if year == (default_year | int) %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                            
                            
                        </div>
                        <div class="col-md-4 text-end" >

                            <!-- <button type="button"  class="btn btn-blue"  onclick="func_add_payment()">Save</button> -->
                            <button type="button"  class="btn btn-blue"  id="btnAddToTable">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
                        </div>
                    </div> 
                    <div class="row mb-15px" >
                        <label class="form-label col-form-label col-md-4">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</label>
                        
                        <div class="col-md-4">
                            <!-- <input  class="form-control price-input"  name="price" id="i_prices" value="{{ '{:,.2f}'.format(datas.price|float) }}" oninput="formatNumberWithCommas(this)"  data-parsley-required="true"/> -->
                            <input  class="form-control price-input"  name="price" id="i_prices" value=""  oninput="formatNumberWithCommas(this)"  data-parsley-required="true"/>
                        </div>
                    </div>
                    <div class="row mb-15px">
                        <label class="form-label col-form-label col-md-4">Term Of Payment</label>
                        <div class="col-md-8">
                           <select class="default-select2 form-control"  name="term" id="i_term" >
                                <option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                {% for term in termOfPaymentModels %}
                                    <option value="{{term.name}}" {% if datas.term_of_payment_id|int == term.name|int %} selected {% endif %}>{{term.name}}</option>
                                {% endfor %}
                            </select>
                            
                        </div>
                    </div>
                    <div class="row mb-15px">

                        <input type="hidden" id="paymentData" value='{{ payments | tojson | safe }}'>

                        <div id="extra-inputs"></div>

                    </div>
                </div>
                <div class="col-sm-6">
                    <div style="overflow-x: auto; width: 100%;">
                        <table id="priceTable">
                        <colgroup>
                            <col style="width: 125px;">  {# ‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏¢‡∏Å #}
                            {% for _ in col_list %}
                                <col style="width: 125px;">
                            {% endfor %}
                          </colgroup>
                        <thead>
                            <!-- ‡πÅ‡∏ñ‡∏ß‡∏õ‡∏µ -->
                            <tr id="thead-years">
                                <td><strong class="mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong></td>
                                {% for year in grouped_payments.keys() %}
                                    <td class="text-center" style="width: 100px; max-width: 100px; text-align:center; padding: 4px 8px;"><input class="form-control-plaintext " name="term_year[]" value="{{ year }}" style="text-align: center;"></td>
                                {% endfor %}
                            </tr>
                            <!-- ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
                        </thead>
                        <tbody>
                            
                            <tr>
                                <td ><strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</strong></td>
                                {% for year in grouped_payments.keys() %}
                                    <td class="text-center" style="width: 75px; max-width: 75px; text-align:center; padding: 4px 8px;">
                                        <input type="radio" name="selectedYear" class="mt-2" value="{{ year }}" {% if year == datas.year %}checked{% endif %}>
                                    </td>
                                {% endfor %}
                            </tr>
                            
                    
                            <!-- ‡πÅ‡∏ñ‡∏ß‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° -->
                            <tr>
                                <td><strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</strong></td>
                                {% for year, items in grouped_payments.items() %}
                                    {% set price = (items[0].price if items|length > 0 and items[0].price|float != 0 else datas.price) %}
                                    <td>
                                        <input class="form-control text-end" name="price_{{ year }}" 
                                            value="{{ '{:,.2f}'.format(price|float) }}" 
                                            oninput="formatNumberWithCommas(this)" style="width: 100px;">
                                    </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ max_terms -->
                            {# ‡πÅ‡∏™‡∏î‡∏á Term ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô max_terms ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤ #}
                                {% for term_index in range(max_terms) %}
                                <tr>
                                    <td><strong>Term {{ term_index + 1 }}</strong></td>
                                    {% for year, items in grouped_payments|dictsort %}

                                        <td>
                                            {% if items|length > term_index %}
                                                <input class="form-control text-end" name="installments_{{ year }}[]"
                                                    value="{{ '{:,.2f}'.format(items[term_index].amount|float) }}"
                                                    oninput="formatNumberWithCommas(this)" style="width: 100px;">
                                                <input type="hidden" name="term_id_{{ year }}[]" value="{{ items[term_index].id }}">
                                                <input type="hidden" name="term_detail_{{ year }}[]" value="{{ items[term_index].term_detail }}">
                                            {% else %}
                                            <div style="width: 100px; height: 34px;"></div>
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    </div>
                </div>
            </div>
            <hr class="my-3">
            <div class="row" >
                <div class="col-sm-6" >
                    <div class="row mb-15px" >
                        <label class="form-label col-form-label col-md-4">Sponsor</label>
                        <div class="col-md-8">

                            <select class="multiple-select2 form-control" multiple  name="employee" id="i_employee" >
                                {% for employee in employees %}
                                    <option value="{{employee.id}}" {% if employee.id in selected_employee  %} selected {% endif %}>{{employee.name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-15px" hidden>
                        <label class="form-label col-form-label col-md-4">Supplier (organization)</label>
                        <div class="col-md-8">
                            <select class="multiple-select2 form-control" multiple name="supplier" id="i_supplier" >
                                {% for supplier in suppliers %}
                                    <option value="{{ supplier.id }}"
                                        {% if supplier.id in selected_suppliers  %} selected {% endif %}>
                                        {{ supplier.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-15px">
                        <label class="form-label col-form-label col-md-4">Oganization</label>
                        <div class="col-md-8">
                            <select class="multiple-select2 form-control" multiple name="organization" id="i_organization">
                                {% for organization in organizations %}
                                    <option value="{{organization.id}}" {% if organization.id in selected_organizations  %} selected {% endif %}>{{organization.name}}</option>
                                {% endfor %}
                            </select>   
                            
                        </div>
                    </div>
                    
                </div>
                <div class="col-sm-6">
                    <div class="row mb-15px" >
                        <label class="form-label col-form-label col-md-4">University</label>
                        <div class="col-md-8">
                            <input  class="form-control" readonly  value="" hidden  display data-parsley-required="true"/>
                            <select class="multiple-select2 form-control" multiple name="university" id="i_university" >
                                {% for university in universitys %}
                                    <option value="{{university.id}}" {% if university.id in selected_agencys  %} selected {% endif %}>{{university.first_name}} {{university.last_name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-15px" >
                        <label class="form-label col-form-label col-md-4">Agency</label>
                        <div class="col-md-8">
                            <input  class="form-control" readonly  value="" hidden  display data-parsley-required="true"/>
                            <select class="multiple-select2 form-control" multiple name="agency" id="i_agency" >
                                {% for agency in agencys %}
                                    <option value="{{agency.id}}" {% if agency.id in selected_agencys  %} selected {% endif %}>{{agency.first_name}} {{agency.last_name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                </div>
                
            </div>

            
            
          
        </div>
        <div class="hljs-wrapper">
            <!-- <pre><code class="html hljs language-xml" data-url="../assets/data/ui-widget-boxes/code-11.json" data-highlighted="yes"></code></pre> -->
        </div>
    </div>
        	

    
    
</form>



{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script src="{{ config.ASSETS_ROOT }}/plugins/datatables.net/js/dataTables.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/datatables.net-bs5/js/dataTables.bootstrap5.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/js/demo/table-manage-responsive.demo.js"></script>

<script src="{{ config.ASSETS_ROOT }}/plugins/moment/min/moment.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/bootstrap-daterangepicker/daterangepicker.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/select2/dist/js/select2.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/bootstrap-datepicker/dist/js/bootstrap-datepicker.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/ion-rangeslider/js/ion.rangeSlider.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/jquery.maskedinput/src/jquery.maskedinput.js"></script>

<script src="{{ config.ASSETS_ROOT }}/plugins/jquery-migrate/dist/jquery-migrate.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/tag-it/js/tag-it.min.js"></script>

<script src="{{ config.ASSETS_ROOT }}/plugins/clipboard/dist/clipboard.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/spectrum-colorpicker2/dist/spectrum.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/select-picker/dist/picker.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/js/demo/form-plugins.demo.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/js/demo/render.highlight.js"></script>
<script src="{{ config.ASSETS_ROOT }}/js/productForSales/mainUpdateProduct.js?v=1.01"></script>
<script>
    const datas = {
        price: "{{ datas.price|default('0.00') }}",
    };

    const yearPriceMap = {
        {% for year, items in grouped_payments.items() %}
            "{{ year }}": "{{ (items[0].price if items and items[0].price|float != 0 else datas.price) }}",
        {% endfor %}
    };
    //console.log("‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô yearPriceMap:", yearPriceMap);
    const selectedYear = {{ datas.year|tojson }};
$(document).ready(function () {
    sortTableByYear(true);  

   
    //-----------------------------
    function formatNumberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    let yearDataStore = {};
    //let yearPriceMap = {};
    //let datas = {};
    function updatePriceByYear(selectedYear) {
        selectedYear = selectedYear?.trim?.() || null;

        console.log("üü° ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ updatePriceByYear:", selectedYear);

        if (!selectedYear) {
            console.warn('‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤');
            return;
        }

        let priceStr =
            (yearPriceMap?.[selectedYear]) ??
            (yearDataStore?.[selectedYear]?.price) ??
            (datas?.price) ??
            '0.00';

        let price = parseFloat(priceStr);
        if (isNaN(price)) price = 0;

        console.log("‚úÖ ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:", selectedYear, "‡∏£‡∏≤‡∏Ñ‡∏≤:", price);

        $('#i_prices').val(
            price.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })
        );
    }

    // ‚úÖ 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
    const initialYear = $('#inputYear').val();
    updatePriceByYear(initialYear);

    // ‚úÖ 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠ user ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏µ‡πÉ‡∏ô dropdown
    $('#inputYear').on('change', function () {
        const selectedYear = $(this).val();
        updatePriceByYear(selectedYear);
    });

              
    let payments = JSON.parse($("#paymentData").val() || "[]");

    let initialTermValue = $("#i_term").val();
    if (initialTermValue) {
        generateInputs(initialTermValue, payments);
    }
    
    $("#i_term").change(function () {
        let termValue = $(this).val().trim();
        let currentYear = $('#inputYear').val();

        // üîÅ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        let currentData = yearDataStore[currentYear];

        // üëá ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏ô‡∏µ‡πâ ‡πÉ‡∏ä‡πâ payments ‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢)
        if (currentData && Array.isArray(currentData.payments)) {
            generateInputs(termValue, currentData.payments);
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏ä‡πâ termValue ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ
            generateInputs(termValue, []);
        }
    });

   $(".price-input").each(function () {
        let value = $(this).val().replace(/,/g, ''); // ‡∏•‡∏ö comma ‡πÄ‡∏î‡∏¥‡∏°
        if (!isNaN(value) && $.trim(value) !== '') {
            $(this).val(parseFloat(value).toLocaleString('en-US')); // ‡πÉ‡∏™‡πà comma ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        }
    }); 

//-----------------------------------------------------//
    //let yearDataStore = {};
    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

    function renderVerticalTable(yearDataStore) {

        

        $('#priceTable').find('colgroup').remove();

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á colgroup ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)
        let colgroupHtml = '<colgroup>';
        colgroupHtml += '<col style="width: 125px;">'; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        Object.keys(yearDataStore).forEach(() => {
            colgroupHtml += '<col style="width: 125px;">';
        });
        colgroupHtml += '</colgroup>';

        // ‡πÉ‡∏™‡πà colgroup ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô thead ‡πÅ‡∏•‡∏∞ tbody
        $('#priceTable').prepend(colgroupHtml);

        if (!yearDataStore || typeof yearDataStore !== 'object') return;

        const years = Object.keys(yearDataStore);
        if (years.length === 0) return;

        const maxTerms = Math.max(...years.map(y => {
            const payments = yearDataStore[y]?.payments || [];
            return payments.length;
        }));

        const $tbody = $('#priceTable tbody');
        $tbody.empty();

    
        // üî∏ ‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        const $thead = $('#priceTable thead #thead-years');
        $thead.empty();  // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô
        let headerRow = '<td><strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong></td>';
        years.forEach(y => {
            headerRow += `<td class="text-center" ><input class="form-control-plaintext text-center" name="term_year[]" value="${y}" style="text-align: center;"></td>`;
        });
        $thead.append(headerRow);

        // üî∏ ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ (radio)
        let selectRow = '<tr><td><strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</strong></td>';
            //const defaultYear = $('#defaultProductYear').val();  // ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            //let defaultYear = $('#defaultProductYear').val() || $('#inputYear').val();
            const defaultYear = sessionStorage.getItem('selectedYear') || $('#defaultProductYear').val();

            console.log("years",years)
        years.forEach(y => {
            const checked = y === defaultYear ? 'checked' : '';
            selectRow += `<td class="text-center">
                <input type="radio" class="mt-2" name="selectedYear" value="${y}" ${checked}>
            </td>`;
        });
        selectRow += '</tr>';
        $tbody.append(selectRow);

        // üî∏ ‡πÅ‡∏ñ‡∏ß‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°
        let priceRow = '<tr><td><strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</strong></td>';
        years.forEach(y => {
            const price = parseFloat(yearDataStore[y].price || 0);
            priceRow += `<td>
                <input class="form-control text-end" name="price_${y}" 
                value="${price.toLocaleString('en-US', {minimumFractionDigits: 2})}" 
                oninput="formatNumberWithCommas(this)" style="width: 100px;">
            </td>`;
        });
        priceRow += '</tr>';
        $tbody.append(priceRow);

        // üî∏ ‡πÅ‡∏ñ‡∏ß Term 1-N
        for (let i = 0; i < maxTerms; i++) {
            let termRow = `<tr><td><strong>Term ${i + 1}</strong></td>`;
            years.forEach(y => {
                const payments = yearDataStore[y]?.payments || [];
                const payment = payments[i];

                if (payment) {
                    termRow += `<td>
                        <input class="form-control text-end" name="installments_${y}[]" 
                            value="${parseFloat(payment.amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}" 
                            oninput="formatNumberWithCommas(this)" style="width: 100px;">
                        <input type="hidden" name="term_id_${y}[]" value="${payment.id || ''}">
                        <input type="hidden" name="term_detail_${y}[]" value="${payment.term_detail || payment.detail || ''}">
                    </td>`;
                } else {
                    termRow += `<td><input class="form-control" readonly hidden style="width: 100px;"></td>`;
                }
            });
            termRow += '</tr>';
            $tbody.append(termRow);
        }
    }
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á input ‡∏á‡∏ß‡∏î‡∏ï‡∏≤‡∏° term ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• payments
    function generateInputs(termValue, payments = []) {
        
        let termNumber = parseInt(termValue, 10);
        let extraInputsContainer = $('#extra-inputs');
        extraInputsContainer.empty();

        if (!Array.isArray(payments)) {
            payments = [];
        }
    
        if (isNaN(termNumber) && payments.length > 0) {
            termNumber = payments.length;
        }

        if (!isNaN(termNumber) && termNumber > 0) {
            //payments.sort((a, b) => a.id - b.id);    
            payments.sort((a, b) => {
                let idA = a.id ? parseInt(a.id) : Infinity;
                let idB = b.id ? parseInt(b.id) : Infinity;
                return idA - idB;
            });

            for (let i = 0; i < termNumber; i++) {
                let payment = payments[i] || {}; // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô
                let defaultID = payments[i] ? payments[i].id : '';
                let defaultDetail = payments[i] ? payments[i].term_detail : '';
                let defaultAmount = payments[i] ? payments[i].amount : '';
                let defaultVat = payments[i] ? payments[i].check_vat : '';
                let usedYear = payment.year || $('#inputYear').val(); // ‚úÖ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ payment ‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß
                //let year = payments[i] ? payments[i].year : '';

                //console.log("payments",payments)
                //console.log("defaultVat",defaultVat)
                
                // üîß ‡∏•‡πâ‡∏≤‡∏á comma ‡∏Å‡πà‡∏≠‡∏ô parse ‡πÅ‡∏•‡∏∞ format
                let formattedAmount = defaultAmount
                ? parseFloat(defaultAmount.toString().replace(/,/g, '')).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })
                : '';

                let isChecked = '';
                if (defaultVat === true || defaultVat === '1' || defaultVat == 1) {
                    isChecked = 'checked';
                } else if ((defaultVat === null || defaultVat === undefined || defaultVat === '') && i === 0) {
                    isChecked = 'checked'; // default checked for first item only
                }

                let newRow = `
                    <div class="row mb-15px">
                        <label class="form-label col-form-label col-md-4">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î ${i + 1}</label>
                        <div class="col-md-4">
                            <input type="text" class="form-control" name="term_id[]" hidden  value="${defaultID}" placeholder="‡∏£‡∏´‡∏±‡∏™">
                            <input type="text" class="form-control" name="term_detail[]" value="${defaultDetail}" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                        </div>
                        <div class="col-md-3 px-0">
                            <input type="text" class="form-control price-input" name="installments[]" value="${formattedAmount}" oninput="formatNumberWithCommas(this)" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î ${i + 1}">
                        </div>
                        <div class="col-md-1" >
                            <input type="hidden" name="check_vat_${usedYear}[${i}]" value="0" />
                            <input type="checkbox" class="form-check-input mt-2" name="check_vat_${usedYear}[${i}]" value="1" ${isChecked}>
                        </div>
                    </div>
                `;
                extraInputsContainer.append(newRow);
            }
        }
    }

    let year = $('#inputYear').val();
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô object
    function gatherFormData() {
        let year = $('#inputYear').val();

        let payments = [];
        $('#extra-inputs .row').each(function () {
            let amount = $(this).find('input[name="installments[]"]').val().replace(/,/g, '');
            let term_detail = $(this).find(`input[name="term_detail[]"]`).val() || '';
            let term_id = $(this).find('input[name="term_id[]"]').val() || '';
            let check_vat = $(this).find('input[type="checkbox"]').is(':checked') ? 1 : 0;

            payments.push({
                amount: amount,
                term_detail: term_detail,
                id: term_id,  // ‡πÄ‡∏Å‡πá‡∏ö id ‡∏•‡∏á‡πÉ‡∏ô array ‡∏î‡πâ‡∏ß‡∏¢
                check_vat: check_vat  // ‡πÄ‡∏Å‡πá‡∏ö id ‡∏•‡∏á‡πÉ‡∏ô array ‡∏î‡πâ‡∏ß‡∏¢
            });

            console.log(payments)
        });

        return {
            year: year,
            payments: payments,
            price: parseFloat($('#i_prices').val().replace(/,/g, '') || 0),
            term: payments.length.toString()
        };
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• payments ‡∏à‡∏≤‡∏Å inputs
    function getPaymentsData() {
        let payments = [];
        $('#extra-inputs .row').each(function () {
            let id = $(this).find('input[name="term_id[]"]').val();
            let detail = $(this).find(`input[name="term_detail[]"]`).val();
            let amount = $(this).find('input[name="installments[]"]').val();
            let check_vat = $(this).find('input[type="checkbox"]').is(':checked') ? 1 : 0;
            payments.push({ id: id, term_detail: detail, amount: amount, check_vat:check_vat });

            console.log(payments)
        });
        return payments;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    function populateForm(data) {
        if (typeof data.price !== 'undefined') {
            $('#i_prices').val(
                (parseFloat(data.price || 0)).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })
            );
        } else {
            $('#i_prices').val('');
        }
        //$('#i_prices').val(formatNumberWithCommas((data.price || 0).toFixed(2)));

        $('#i_term').val(data.term || '').trigger('change'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á input ‡∏á‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà
        $('#paymentData').val(JSON.stringify(data.payments || []));

        let payments = Array.isArray(data.payments) ? data.payments : [];
        let year = data.year;
        // ‡πÅ‡∏™‡∏î‡∏á inputs ‡∏á‡∏ß‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• payments
        generateInputs(data.term, data.payments, year);
    }


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    function clearForm() {
        $('#i_prices').val(0);
        $('#i_term').val('').trigger('change');
        $('#paymentData').val('');
        $('#extra-inputs').empty();
    }
    let groupedPayments = {{ grouped_payments|tojson|safe }};
    console.log('Original groupedPayments:', groupedPayments);


    // ‡πÅ‡∏õ‡∏•‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    for (let year in groupedPayments) {
        const paymentsArray = groupedPayments[year];
        console.log("Before map:", paymentsArray);
    
        if (Array.isArray(paymentsArray) && paymentsArray.length > 0) {
            yearDataStore[year] = {
                year: year,
                payments: paymentsArray.map(function(payment) {
                    //console.log('Inside map:', payment);  // üü® Debug ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢
                    return {
                        amount: payment.amount,
                        term_detail: payment.term_detail,
                        id: payment.id,
                        check_vat: payment.check_vat
                    };
                }),
                price: paymentsArray[0].price,
                term: paymentsArray.length.toString(),
    
            
            };
        }
    }

    console.log("Updated yearDataStore:", yearDataStore);

    //------------------ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏µ --------------------------------
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    let currentYear = $('#inputYear').val();
    sessionStorage.setItem('selectedYear', currentYear);

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô paymentData ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô JSON (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fallback)
    let initialPayments = JSON.parse($('#paymentData').val() || "[]");
    let initialTerm = $('#i_term').val();
    let initialTermDetail = $('#i_termDetail').val();

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    if (yearDataStore[currentYear]) {
        populateForm(yearDataStore[currentYear]);
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó i_term ‡∏î‡πâ‡∏ß‡∏¢
        $('#i_term').val(yearDataStore[currentYear].term);
        generateInputs(yearDataStore[currentYear].term, yearDataStore[currentYear].payments);
    } else if (initialTerm) {
        generateInputs(initialTerm, initialPayments);
    }

    // üîÅ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏µ inputYear ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
    $('#inputYear').change(function () {
        /*let selectedYear = $(this).val();
        sessionStorage.setItem('selectedYear', selectedYear);

        if (yearDataStore[selectedYear]) {
            populateForm(yearDataStore[selectedYear]);
        } else {
            clearForm();
        }*/
        let selectedYear = $(this).val();
        let data = yearDataStore[selectedYear];

        if (data) {
            populateForm(data); // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏µ‡∏ô‡∏±‡πâ‡∏ô
            updatePriceByYear(selectedYear); 
        } else {
            clearForm(); // ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        }
    });

    

    //-------------------------  ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏° --------------------------------//
    $('#btnAddToTable').click(function () {
        let year = $('#inputYear').val();
        let price = $('#i_prices').val();
        let term = $('#i_term').val();
        let term_detail = $('#i_termDetail').val();

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå term_detail ‡πÅ‡∏•‡∏∞ installments
        let termAmounts = [];
        let termDetails = [];
        let termIDs = [];
        let termVat = [];
        $('#extra-inputs .row').each(function () {
            let amount = ($(this).find('input[name="installments[]"]').val() || '').replace(/,/g, '');
            let detail = $(this).find('input[name="term_detail[]"]').val() || '';
            let id = $(this).find('input[name="term_id[]"]').val() || '';
            let check_vat = $(this).find('input[name="check_vat[]"]').is(':checked') ? 1 : 0;

            //let amount = $(this).find('input[name="installments"]').val().replace(/,/g, '');
            //let detail = $(this).find(`input[name="term_detail[]"]`).val() || '';
            //let id = $(this).find('input[name="term_id[]"]').val() || '';
            //let check_vat = $(this).find('input[type="checkbox"]').is(':checked') ? 1 : 0;
            //let check_vat = $(this).find(`input[name="check_vat_${year}[]"]`).is(':checked') ? 1 : 0;

            if (amount && parseFloat(amount) !== 0) {
                termAmounts.push(amount);
                termDetails.push(detail);
                termIDs.push(id);
                termVat.push(check_vat);
            }

        });

       

        // üî∏ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        let $existingRow = $(`#tableBody tr[data-year="${year}"]`);
        if ($existingRow.length) {
            $existingRow.remove();
        }



        yearDataStore[year] = gatherFormData();

        
        // üî∏ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏≠‡∏∑‡πà‡∏ô
        Object.keys(yearDataStore).forEach(y => {
            if (y !== year) yearDataStore[y].selected = false;
        });
        // üî∏ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á
        renderVerticalTable(yearDataStore);
        

        // ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°
        let prevSelectedYear = sessionStorage.getItem('selectedYear') || $('#inputYear').val();

        if (yearDataStore.hasOwnProperty(prevSelectedYear)) {
            // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
            sessionStorage.setItem('selectedYear', prevSelectedYear);
            $(`input[name="selectedYear"][value="${prevSelectedYear}"]`).prop('checked', true);
            $('#inputYear').val(prevSelectedYear).trigger('change');
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
            sessionStorage.setItem('selectedYear', year);
            $(`input[name="selectedYear"][value="${year}"]`).prop('checked', true);
            $('#inputYear').val(year).trigger('change');
        }
        //$('#tableBody').append(newRow);
        sortTableByYear(true);
        
        /*
        /// üü© ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        yearDataStore[year] = gatherFormData();

        // üü© ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏õ‡∏µ 2025 ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô
        let defaultYear = $('#defaultProductYear').val();
        $('#inputYear').val(defaultYear).trigger('change');

        // üü© ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
        if (yearDataStore[defaultYear]) {
            populateForm(yearDataStore[defaultYear]);
        } else {
            clearForm();
        }
            */

        
    });

    $(document).on('input', 'input[name="term_year[]"]', function () {
        let values = [];
        let duplicates = false;
    
        $('input[name="term_year[]"]').each(function () {
            let val = $(this).val();
            if (val) {
                if (values.includes(val)) {
                    duplicates = true;
                    return false; // ‡πÄ‡∏à‡∏≠‡∏ã‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î loop
                }
                values.push(val);
            }
        });
    
        if (duplicates) {
            alert('‡∏û‡∏ö‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥');
            $(this).addClass('is-invalid');
        } else {
            $('input[name="term_year[]"]').removeClass('is-invalid');
        }
    });

    $(document).on('input', 'input[name="term_year[]"]', function () {
        let values = [];
        let duplicates = false;

        $('input[name="term_year[]"]').each(function () {
            let val = $(this).val();
            if (val) {
                if (values.includes(val)) {
                    duplicates = true;
                    return false;
                }
                values.push(val);
            }
        });

        if (duplicates) {
            alert('‡∏û‡∏ö‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥');
            $(this).addClass('is-invalid');
            return;
        } else {
            $('input[name="term_year[]"]').removeClass('is-invalid');
        }

        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤ data-year ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
        let $row = $(this).closest('tr');
        let oldYear = $row.attr('data-year');
        let newYear = $(this).val();

        if (oldYear !== newYear) {
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô attribute
            $row.attr('data-year', newYear);

            // ‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô yearDataStore
            if (yearDataStore[oldYear]) {
                yearDataStore[newYear] = { ...yearDataStore[oldYear], year: newYear };
                delete yearDataStore[oldYear];
            }

            // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠ field input ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà
            $row.find('input[name^="price_"]').attr('name', `price_${newYear}`);
            $row.find('input[name^="installments_"]').each(function (i) {
                $(this).attr('name', `installments_${newYear}[]`);
            });
            $row.find('input[name^="term_detail_"]').each(function (i) {
                $(this).attr('name', `term_detail_${newYear}[]`);
            });
            $row.find('input[name^="term_id_"]').each(function (i) {
                $(this).attr('name', `term_id_${newYear}[]`);
            });
        }
    });
     
});



</script>
<script>
//console.log({{datas|tojson|safe}})
//console.log("grouped_payments")
//console.log({{grouped_payments|tojson|safe}})

function sweetAlertDelSign(id_file,id_product) {
    swal({
        title: "Are you sure?",
        text: "Delete?",
        icon: "error",
        buttons: {
            cancel: {
                text: "Cancel",
                value: null,
                visible: true,
                className: "btn btn-dark",
                closeModal: true,
            },
            confirm: {
                text: "Yes, Delete.",
                value: true,
                visible: true,
                className: "btn btn-danger",
                closeModal: true,
            },
        },
    }).then((result) => {
        if (result.dismiss !== "cancel") {
            post("/product/product_delete_file", {
                id_file: id_file,
                id_product: id_product,
                // path: $("#path").val(),
            });
        }
    });
}

function formatWithCommasKeepDecimal(value) {
    let parts = value.toString().split(".");
    parts[0] = parseFloat(parts[0].replace(/,/g, '') || 0).toLocaleString('en-US');
    return parts.join(".");
}

function formatNumberWithCommas(input) {
    /*
    let value = input.value;

    // ‡∏•‡∏ö comma ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    value = value.replace(/,/g, '');

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!isNaN(value) && value !== '') {
        value = parseFloat(value).toLocaleString('en-US'); 
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ input
    input.value = value; 
    */
    if (!input || typeof input.value !== 'string') {
        return;
    }
    // ‡∏•‡∏ö comma ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô
    let value = input.value.replace(/,/g, '');

    let regex = /^\d+(\.\d{0,2})?$/;
    if (!regex.test(value)) {
        input.value = input.value.slice(0, -1); // ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å
        return;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    let number = parseFloat(value);

    // ‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
    let parts = value.split('.');
    parts[0] = parseInt(parts[0], 10).toLocaleString(); // ‡πÄ‡∏û‡∏¥‡πà‡∏° comma ‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤

    // ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö
    input.value = parts.length > 1 ? parts.join('.') : parts[0];
}

function formatNumberInter(input) {

    let value = input.value;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!value) {
        input.value = ''; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå
        return;
    }

    // ‡∏•‡∏ö comma ‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
    value = value.replace(/,/g, '');

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (isNaN(value)) {
        input.value = ''; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
        return;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°
    let number = parseInt(value, 10);

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏° comma ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    input.value = number.toLocaleString();
}
</script>
<script>
function func_add_payment() {
    const year = $('#inputYear').val();
    const price = parseFloat($('#i_price').val().replace(/,/g, '')) || 0;
    const term = $('#i_term').val();
    const product_id = $('#id-update').val();  // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ input ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ

    const term_ids = [];
    const term_details = [];
    const term_amounts = [];

    $('input[name="term_id"]').each(function () {
        term_ids.push($(this).val());
    });

    $('input[name="term_detail"]').each(function () {
        term_details.push($(this).val());
    });

    $('input[name="installments"]').each(function () {
        let amount = parseFloat($(this).val().replace(/,/g, '')) || 0;
        term_amounts.push(amount);
    });

    const terms = [];
    for (let i = 0; i < term_details.length; i++) {
        terms.push({
            id: term_ids[i] || null,
            detail: term_details[i],
            amount: term_amounts[i]
        });
    }

    const dataToSend = {
        year: year,
        price: price,
        term: term,
        product_id: product_id,
        terms: terms
    };
    console.log("dataToSend")
    console.log(dataToSend)
    return
    $.ajax({
        url: "/save_payment",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(dataToSend),
        success: function (response) {
            if (response.status === "success") {
                location.reload();
            } else {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + response.message);
            }
        }
    });
}

</script>
<script>
    function sortTableByYear(ascending = true) {
        let $rows = $('#tableBody tr').get();

        $rows.sort(function(a, b) {
            let yearA = parseInt($(a).data('year'), 10);
            let yearB = parseInt($(b).data('year'), 10);
            return ascending ? yearA - yearB : yearB - yearA;
        });

        $('#tableBody').empty(); // üîß ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô
        $.each($rows, function(index, row) {
            $('#tableBody').append(row); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß
        });
    }
/*
    function updateCurrentYearData() {
        const year = $('#inputYear').val();
        const payments = [];
    
        $('#extra-inputs .row').each(function () {
            const amount = $(this).find('input[name="installments[]"]').val().replace(/,/g, '') || '0';
            const term_detail = $(this).find(`input[name="term_detail_[]"]`).val() || '';
            const term_id = $(this).find('input[name="term_id[]"]').val() || '';
            const check_vat = $(this).find(`input[name="check_vat_${year}[]"]`).is(':checked') ? 1 : 0;
    
            if (parseFloat(amount) !== 0) {
                payments.push({
                    amount: amount,
                    term_detail_etail,
                    id: term_id,
                    check_vat: check_vat
                });
            }
        });
    
        yearDataStore[year] = {
            year: year,
            payments: payments,
            price: parseFloat($('#i_prices').val().replace(/,/g, '') || 0),
            term: payments.length.toString()
        };
    
        console.log('üìå yearDataStore updated on input:', year, yearDataStore[year]);
    }

    $('#extra-inputs').on('input change', 'input', function () {
        updateCurrentYearData();
    });
   */ 
</script>











{% endblock javascripts %}
